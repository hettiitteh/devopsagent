<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevOps SRE Agent ‚Äî Dashboard</title>
    <style>
        /* ‚îÄ‚îÄ‚îÄ Reset & Base ‚îÄ‚îÄ‚îÄ */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        :root {
            --bg: #0f1117;
            --bg-card: #181b23;
            --bg-card-hover: #1e2230;
            --bg-input: #232736;
            --border: #2a2e3e;
            --text: #e1e4ed;
            --text-dim: #8b8fa3;
            --accent: #6c72ff;
            --accent-hover: #8287ff;
            --green: #34d399;
            --green-bg: rgba(52,211,153,.12);
            --red: #f87171;
            --red-bg: rgba(248,113,113,.12);
            --yellow: #fbbf24;
            --yellow-bg: rgba(251,191,36,.12);
            --blue: #60a5fa;
            --blue-bg: rgba(96,165,250,.12);
            --orange: #fb923c;
            --radius: 10px;
            --radius-sm: 6px;
            --font: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --mono: 'JetBrains Mono', 'Fira Code', 'SF Mono', Consolas, monospace;
        }
        body { font-family: var(--font); background: var(--bg); color: var(--text); line-height: 1.6; min-height: 100vh; }
        a { color: var(--accent); text-decoration: none; }

        /* ‚îÄ‚îÄ‚îÄ Layout ‚îÄ‚îÄ‚îÄ */
        .app { display: flex; min-height: 100vh; }
        .sidebar {
            width: 260px; background: var(--bg-card); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; flex-shrink: 0; position: fixed;
            top: 0; left: 0; bottom: 0; z-index: 100;
        }
        .sidebar-brand {
            padding: 20px 20px 16px; border-bottom: 1px solid var(--border);
        }
        .sidebar-brand h1 {
            font-size: 18px; font-weight: 700; letter-spacing: -.3px;
            background: linear-gradient(135deg, var(--accent), var(--blue));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .sidebar-brand p { font-size: 11px; color: var(--text-dim); margin-top: 2px; }
        .sidebar-nav { flex: 1; padding: 12px 10px; overflow-y: auto; }
        .nav-section { margin-bottom: 16px; }
        .nav-section-title { font-size: 10px; text-transform: uppercase; letter-spacing: 1.2px; color: var(--text-dim); padding: 0 10px; margin-bottom: 6px; }
        .nav-item {
            display: flex; align-items: center; gap: 10px; padding: 9px 12px;
            border-radius: var(--radius-sm); cursor: pointer; font-size: 13px;
            color: var(--text-dim); transition: all .15s;
        }
        .nav-item:hover { background: var(--bg-card-hover); color: var(--text); }
        .nav-item.active { background: rgba(108,114,255,.12); color: var(--accent); font-weight: 500; }
        .nav-item .icon { font-size: 16px; width: 20px; text-align: center; }
        .nav-item .badge {
            margin-left: auto; background: var(--red); color: #fff; font-size: 10px;
            padding: 1px 6px; border-radius: 10px; font-weight: 600;
        }
        .sidebar-footer {
            padding: 12px 16px; border-top: 1px solid var(--border); font-size: 11px; color: var(--text-dim);
        }
        .ws-status { display: flex; align-items: center; gap: 6px; }
        .ws-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--red); }
        .ws-dot.connected { background: var(--green); }
        .main { margin-left: 260px; flex: 1; padding: 24px 28px; }

        /* ‚îÄ‚îÄ‚îÄ Page Sections ‚îÄ‚îÄ‚îÄ */
        .page { display: none; }
        .page.active { display: block; }
        .page-header { margin-bottom: 24px; }
        .page-header h2 { font-size: 22px; font-weight: 700; letter-spacing: -.3px; }
        .page-header p { color: var(--text-dim); font-size: 13px; margin-top: 4px; }

        /* ‚îÄ‚îÄ‚îÄ Cards ‚îÄ‚îÄ‚îÄ */
        .card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 20px; margin-bottom: 16px;
        }
        .card-title { font-size: 13px; font-weight: 600; color: var(--text-dim); text-transform: uppercase; letter-spacing: .5px; margin-bottom: 12px; }

        /* ‚îÄ‚îÄ‚îÄ Stat Grid ‚îÄ‚îÄ‚îÄ */
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 14px; margin-bottom: 20px; }
        .stat-card {
            background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius);
            padding: 18px 20px; display: flex; align-items: center; gap: 14px;
        }
        .stat-icon {
            width: 42px; height: 42px; border-radius: var(--radius-sm);
            display: flex; align-items: center; justify-content: center; font-size: 20px;
        }
        .stat-icon.green { background: var(--green-bg); }
        .stat-icon.red { background: var(--red-bg); }
        .stat-icon.blue { background: var(--blue-bg); }
        .stat-icon.yellow { background: var(--yellow-bg); }
        .stat-value { font-size: 26px; font-weight: 700; line-height: 1.1; }
        .stat-label { font-size: 12px; color: var(--text-dim); }

        /* ‚îÄ‚îÄ‚îÄ Tables ‚îÄ‚îÄ‚îÄ */
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { text-align: left; padding: 10px 12px; color: var(--text-dim); font-weight: 500; border-bottom: 1px solid var(--border); font-size: 11px; text-transform: uppercase; letter-spacing: .5px; }
        td { padding: 10px 12px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        tr:hover td { background: var(--bg-card-hover); }
        .badge-status {
            display: inline-block; padding: 2px 10px; border-radius: 12px;
            font-size: 11px; font-weight: 600; text-transform: uppercase;
        }
        .badge-healthy { background: var(--green-bg); color: var(--green); }
        .badge-unhealthy { background: var(--red-bg); color: var(--red); }
        .badge-unknown { background: var(--yellow-bg); color: var(--yellow); }
        .badge-degraded { background: var(--yellow-bg); color: var(--orange); }
        .badge-open { background: var(--red-bg); color: var(--red); }
        .badge-acknowledged { background: var(--yellow-bg); color: var(--yellow); }
        .badge-investigating { background: var(--blue-bg); color: var(--blue); }
        .badge-resolved { background: var(--green-bg); color: var(--green); }
        .badge-critical { background: var(--red-bg); color: var(--red); }
        .badge-high { background: rgba(251,146,60,.15); color: var(--orange); }
        .badge-medium { background: var(--yellow-bg); color: var(--yellow); }
        .badge-low { background: var(--blue-bg); color: var(--blue); }
        .badge-info { background: rgba(148,163,184,.12); color: #94a3b8; }

        /* ‚îÄ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ‚îÄ */
        .btn {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 8px 16px; border-radius: var(--radius-sm); border: none;
            font-size: 13px; font-weight: 500; cursor: pointer; transition: all .15s;
            font-family: var(--font);
        }
        .btn-primary { background: var(--accent); color: #fff; }
        .btn-primary:hover { background: var(--accent-hover); }
        .btn-secondary { background: var(--bg-input); color: var(--text); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--bg-card-hover); }
        .btn-danger { background: rgba(248,113,113,.15); color: var(--red); border: 1px solid rgba(248,113,113,.25); }
        .btn-danger:hover { background: rgba(248,113,113,.25); }
        .btn-sm { padding: 5px 10px; font-size: 12px; }
        .btn-group { display: flex; gap: 8px; flex-wrap: wrap; }

        /* ‚îÄ‚îÄ‚îÄ Forms ‚îÄ‚îÄ‚îÄ */
        .form-group { margin-bottom: 14px; }
        .form-label { display: block; font-size: 12px; font-weight: 500; color: var(--text-dim); margin-bottom: 5px; }
        .form-input, .form-select, .form-textarea {
            width: 100%; padding: 9px 12px; background: var(--bg-input); border: 1px solid var(--border);
            border-radius: var(--radius-sm); color: var(--text); font-size: 13px;
            font-family: var(--font); transition: border-color .15s;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--accent); }
        .form-textarea { min-height: 80px; resize: vertical; font-family: var(--mono); font-size: 12px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .form-inline { display: flex; gap: 8px; }
        .form-inline .form-input { flex: 1; }

        /* ‚îÄ‚îÄ‚îÄ Agent Chat ‚îÄ‚îÄ‚îÄ */
        .chat-container { display: flex; flex-direction: column; height: calc(100vh - 140px); }
        .chat-messages {
            flex: 1; overflow-y: auto; padding: 16px 0; display: flex; flex-direction: column; gap: 12px;
        }
        .chat-msg {
            max-width: 85%; padding: 12px 16px; border-radius: var(--radius); font-size: 13px; line-height: 1.65;
        }
        .chat-msg.user { background: rgba(108,114,255,.15); align-self: flex-end; border-bottom-right-radius: 2px; }
        .chat-msg.assistant { background: var(--bg-card); border: 1px solid var(--border); align-self: flex-start; border-bottom-left-radius: 2px; }
        .chat-msg.system { background: var(--yellow-bg); color: var(--yellow); align-self: center; font-size: 12px; padding: 6px 14px; }
        .chat-msg pre { background: var(--bg); padding: 10px; border-radius: var(--radius-sm); overflow-x: auto; font-size: 12px; margin-top: 8px; font-family: var(--mono); }
        .chat-input-area { display: flex; gap: 8px; padding-top: 12px; border-top: 1px solid var(--border); }
        .chat-input-area .form-input { flex: 1; }

        /* ‚îÄ‚îÄ‚îÄ Event Log ‚îÄ‚îÄ‚îÄ */
        .event-log {
            max-height: 350px; overflow-y: auto; font-family: var(--mono); font-size: 12px;
            background: var(--bg); border-radius: var(--radius-sm); padding: 12px;
            border: 1px solid var(--border);
        }
        .event-entry { padding: 4px 0; border-bottom: 1px solid rgba(42,46,62,.5); display: flex; gap: 10px; }
        .event-time { color: var(--text-dim); white-space: nowrap; min-width: 80px; }
        .event-method { color: var(--accent); font-weight: 600; min-width: 180px; }
        .event-data { color: var(--text); word-break: break-all; }

        /* ‚îÄ‚îÄ‚îÄ Modal ‚îÄ‚îÄ‚îÄ */
        .modal-overlay {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,.6);
            z-index: 1000; justify-content: center; align-items: center;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius);
            width: 520px; max-width: 90vw; max-height: 85vh; overflow-y: auto; padding: 24px;
        }
        .modal h3 { font-size: 16px; margin-bottom: 16px; }

        /* ‚îÄ‚îÄ‚îÄ Architecture Diagram ‚îÄ‚îÄ‚îÄ */
        .arch-flow { display: flex; flex-direction: column; gap: 12px; align-items: center; padding: 20px 0; }
        .arch-box {
            background: var(--bg-input); border: 1px solid var(--border); border-radius: var(--radius);
            padding: 14px 24px; text-align: center; width: 100%; max-width: 600px;
        }
        .arch-box h4 { color: var(--accent); font-size: 13px; margin-bottom: 4px; }
        .arch-box p { font-size: 12px; color: var(--text-dim); }
        .arch-arrow { color: var(--text-dim); font-size: 20px; }
        .arch-row { display: flex; gap: 12px; width: 100%; max-width: 600px; }
        .arch-row .arch-box { flex: 1; }

        /* ‚îÄ‚îÄ‚îÄ Scrollbar ‚îÄ‚îÄ‚îÄ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

        /* ‚îÄ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ‚îÄ */
        @media (max-width: 900px) {
            .sidebar { width: 220px; }
            .main { margin-left: 220px; }
            .form-row { grid-template-columns: 1fr; }
        }
        @media (max-width: 640px) {
            .sidebar { display: none; }
            .main { margin-left: 0; }
        }
        .loading { display: inline-block; width: 16px; height: 16px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin .6s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-dim); }
        .empty-state .icon { font-size: 36px; margin-bottom: 10px; }
        .tag { display: inline-block; padding: 2px 8px; background: var(--bg-input); border-radius: 4px; font-size: 11px; margin-right: 4px; }
        .tool-card { padding: 14px; background: var(--bg-input); border-radius: var(--radius-sm); border: 1px solid var(--border); }
        .tool-card h4 { font-size: 13px; font-weight: 600; color: var(--accent); margin-bottom: 4px; }
        .tool-card p { font-size: 12px; color: var(--text-dim); line-height: 1.5; }
        .tool-card .tag { margin-top: 6px; }
        .tools-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; }
    </style>
</head>
<body>
<div class="app">
    <!-- ‚îÄ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ‚îÄ -->
    <aside class="sidebar">
        <div class="sidebar-brand">
            <h1>DevOps SRE Agent</h1>
            <p>OpenClaw Architecture</p>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Overview</div>
                <div class="nav-item active" data-page="dashboard"><span class="icon">üìä</span> Dashboard</div>
                <div class="nav-item" data-page="architecture"><span class="icon">üèóÔ∏è</span> How It Works</div>
            </div>
            <div class="nav-section">
                <div class="nav-section-title">Agent</div>
                <div class="nav-item" data-page="chat"><span class="icon">üí¨</span> Agent Chat</div>
                <div class="nav-item" data-page="tools"><span class="icon">üîß</span> Tools</div>
            </div>
            <div class="nav-section">
                <div class="nav-section-title">Operations</div>
                <div class="nav-item" data-page="monitoring"><span class="icon">üì°</span> Monitoring</div>
                <div class="nav-item" data-page="incidents"><span class="icon">üö®</span> Incidents <span class="badge" id="incident-badge" style="display:none">0</span></div>
                <div class="nav-item" data-page="approvals"><span class="icon">‚úã</span> Approvals <span class="badge" id="approval-badge" style="display:none">0</span></div>
                <div class="nav-item" data-page="alerts"><span class="icon">üîî</span> Alert Rules</div>
                <div class="nav-item" data-page="playbooks"><span class="icon">üìã</span> Playbooks <span class="badge" id="suggestion-badge" style="display:none">0</span></div>
                <div class="nav-item" data-page="rca"><span class="icon">üìÑ</span> RCA Reports <span class="badge" id="rca-badge" style="display:none">0</span></div>
                <div class="nav-item" data-page="risks"><span class="icon">‚ö†Ô∏è</span> Risk Assessment <span class="badge" id="risk-badge" style="display:none">0</span></div>
            </div>
            <div class="nav-section">
                <div class="nav-section-title">System</div>
                <div class="nav-item" data-page="learnings"><span class="icon">üß†</span> Learnings</div>
                <div class="nav-item" data-page="audit"><span class="icon">üìù</span> Audit Log</div>
                <div class="nav-item" data-page="events"><span class="icon">üìú</span> Live Events</div>
                <div class="nav-item" data-page="security"><span class="icon">üõ°Ô∏è</span> Security Audit</div>
            </div>
        </nav>
        <div class="sidebar-footer">
            <div class="ws-status">
                <span class="ws-dot" id="ws-dot"></span>
                <span id="ws-label">Disconnected</span>
            </div>
        </div>
    </aside>

    <!-- ‚îÄ‚îÄ‚îÄ Main Content ‚îÄ‚îÄ‚îÄ -->
    <main class="main">

        <!-- Dashboard -->
        <div class="page active" id="page-dashboard">
            <div class="page-header">
                <h2>Dashboard</h2>
                <p>Real-time overview of your production systems</p>
            </div>
            <div class="stat-grid" id="stats-grid">
                <div class="stat-card"><div class="stat-icon green">‚úÖ</div><div><div class="stat-value" id="stat-healthy">-</div><div class="stat-label">Healthy Services</div></div></div>
                <div class="stat-card"><div class="stat-icon red">‚ùå</div><div><div class="stat-value" id="stat-unhealthy">-</div><div class="stat-label">Unhealthy Services</div></div></div>
                <div class="stat-card"><div class="stat-icon yellow">‚ö†Ô∏è</div><div><div class="stat-value" id="stat-incidents">-</div><div class="stat-label">Active Incidents</div></div></div>
                <div class="stat-card"><div class="stat-icon blue">üîß</div><div><div class="stat-value" id="stat-tools">-</div><div class="stat-label">Available Tools</div></div></div>
                <div class="stat-card"><div class="stat-icon yellow" style="background:rgba(251,191,36,.12);">‚ö†Ô∏è</div><div><div class="stat-value" id="stat-risks">0</div><div class="stat-label">Open Risks</div></div></div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                <div class="card">
                    <div class="card-title">Monitored Services</div>
                    <div class="table-wrap"><table><thead><tr><th>Service</th><th>Type</th><th>Status</th><th>Last Check</th></tr></thead><tbody id="dashboard-services"><tr><td colspan="4" class="empty-state">Loading...</td></tr></tbody></table></div>
                </div>
                <div class="card">
                    <div class="card-title">Recent Incidents</div>
                    <div class="table-wrap"><table><thead><tr><th>Severity</th><th>Title</th><th>Service</th><th>Status</th></tr></thead><tbody id="dashboard-incidents"><tr><td colspan="4" class="empty-state">Loading...</td></tr></tbody></table></div>
                </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px;">
                <div class="card">
                    <div class="card-title">Resolution Insights (Learning)</div>
                    <div id="insights-container" style="font-size:13px;color:var(--text-dim);">
                        <div class="empty-state">Loading insights...</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">Proactive Risks</div>
                    <div id="dashboard-risks-container" style="font-size:13px;color:var(--text-dim);">
                        <div class="empty-state">Loading risks...</div>
                    </div>
                </div>
            </div>
            <div style="margin-top:16px;">
                <div class="card">
                    <div class="card-title" style="display:flex;justify-content:space-between;align-items:center;">
                        <span>Vector Embeddings</span>
                        <div style="display:flex;gap:8px;">
                            <button class="btn btn-small" onclick="migrateEmbeddings()" title="Embed records that are missing embeddings">Migrate</button>
                            <button class="btn btn-small btn-danger" onclick="reindexEmbeddings()" title="Re-embed ALL records (force refresh)">Re-index All</button>
                        </div>
                    </div>
                    <div id="embedding-status-container" style="font-size:13px;color:var(--text-dim);">
                        <div class="empty-state">Loading embedding status...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Architecture / How It Works -->
        <div class="page" id="page-architecture">
            <div class="page-header">
                <h2>How It Works</h2>
                <p>An intelligent SRE agent built on the OpenClaw gateway-centric orchestration pattern, enhanced with vector embeddings, self-improving learning, and LLM-driven reasoning</p>
            </div>

            <!-- Architecture Overview -->
            <div class="card">
                <div class="card-title">Architecture Overview</div>
                <div class="arch-flow">
                    <div class="arch-box" style="border-color:var(--accent);">
                        <h4>Gateway (Port 18789)</h4>
                        <p>WebSocket + HTTP JSON-RPC server. All clients, UIs, and integrations communicate through this single entry point. Manages sessions, routes messages, and broadcasts real-time events across the entire platform.</p>
                    </div>
                    <div class="arch-arrow">‚Üï</div>
                    <div class="arch-box" style="border-color:var(--blue);">
                        <h4>Agent Engine (LLM-Powered Agentic Loop)</h4>
                        <p>Receives a task, builds a dynamic 11-section system prompt (including learning insights and semantic recommendations), sends to GPT-4o with tool definitions, executes tool calls through the policy engine, and loops until done. Human approval gates pause the loop for sensitive actions and resume automatically once approved.</p>
                    </div>
                    <div class="arch-arrow">‚Üï</div>
                    <div class="arch-row">
                        <div class="arch-box"><h4>Tool Policy Engine</h4><p>Profile-based access control (minimal / sre / full). Config-driven approval lists allow runtime toggling of which tools need human sign-off before execution.</p></div>
                        <div class="arch-box"><h4>Dynamic System Prompt</h4><p>11 sections assembled per-session: Identity, Capabilities, Tools, Safety, Context, Monitoring Rules, Incident Protocol, Playbook Standards, Learning Insights, Semantic Recommendations, and Time.</p></div>
                    </div>
                    <div class="arch-arrow">‚Üï</div>
                    <div class="arch-row">
                        <div class="arch-box"><h4>14 SRE Tools</h4><p>health_check, metrics_query, log_search, kubectl_exec, docker_exec, ssh_exec, service_restart, playbook_run, playbook_create, incident_manage, alert_manage, network_diag, system_info, learning_query.</p></div>
                        <div class="arch-box"><h4>Playbook Engine (DB-Backed)</h4><p>Database-persisted runbooks with ordered steps, multi-severity triggers, retry/abort/continue handling, auto-trigger on incidents, dry-run support, enable/disable toggle, and playbook authoring standards enforced by the LLM.</p></div>
                    </div>
                    <div class="arch-arrow">‚Üï</div>
                    <div class="arch-row">
                        <div class="arch-box"><h4>Monitoring Service</h4><p>Per-service scheduled health checks, state transition detection (HEALTHY/UNHEALTHY), LLM-driven severity triage, auto-incident creation, auto-playbook triggering, and auto-resolution tracking.</p></div>
                        <div class="arch-box"><h4>Incident &amp; RCA Pipeline</h4><p>Auto-created incidents with LLM-classified severity. On resolution: auto-generates a comprehensive Root Cause Analysis report (summary, timeline, root cause, impact, lessons learned, preventive measures) sent for human review.</p></div>
                    </div>
                    <div class="arch-arrow">‚Üï</div>
                    <div class="arch-row">
                        <div class="arch-box" style="border-color:var(--green);">
                            <h4>Learning &amp; Memory System</h4>
                            <p>Every resolution (chat, playbook, auto-recovery) is recorded. The system tracks tool sequences, success rates, and resolution times per service. This data feeds back into the system prompt so the LLM makes better decisions over time.</p>
                        </div>
                        <div class="arch-box" style="border-color:var(--green);">
                            <h4>Vector Embeddings (Semantic Search)</h4>
                            <p>Incidents, resolutions, and RCA reports are embedded via OpenAI text-embedding-3-small. In-memory cosine similarity enables fast semantic search, cross-service pattern transfer, and near-duplicate playbook detection ‚Äî replacing expensive multi-LLM-call keyword search.</p>
                        </div>
                    </div>
                    <div class="arch-arrow">‚Üï</div>
                    <div class="arch-row">
                        <div class="arch-box"><h4>Proactive Risk Assessment</h4><p>Every 30 minutes, the LLM analyzes recent incidents, metrics, and patterns to identify emerging risks before they become incidents. Risks are surfaced on the dashboard for human review.</p></div>
                        <div class="arch-box"><h4>AI Playbook Suggestions</h4><p>Frequency-based pattern detection + LLM-powered analysis identify recurring resolution patterns and suggest new automated playbooks. Suggestions go through human approval before activation.</p></div>
                    </div>
                </div>
            </div>

            <!-- Agentic Loop -->
            <div class="card">
                <div class="card-title">The Agentic Loop (How the Agent Thinks)</div>
                <ol style="padding-left:20px;font-size:13px;color:var(--text-dim);line-height:2;">
                    <li><strong style="color:var(--text)">User sends a message</strong> (e.g., "Check health of all services" or "What caused the MySQL outage?")</li>
                    <li><strong style="color:var(--text)">Dynamic system prompt assembled</strong> ‚Äî includes current context (active incidents, unhealthy services), learning insights from past resolutions, semantic recommendations from similar problems across services, and playbook authoring standards</li>
                    <li><strong style="color:var(--text)">Message + 14 tool definitions sent to LLM</strong> (OpenAI GPT-4o)</li>
                    <li><strong style="color:var(--text)">LLM responds</strong> with reasoning text and/or tool calls</li>
                    <li><strong style="color:var(--text)">Tool calls are policy-checked</strong> ‚Äî if the tool requires human approval, an approval request is created and the loop pauses until a human approves via the UI</li>
                    <li><strong style="color:var(--text)">Approved tools are executed</strong>, results appended to conversation and sent back to LLM</li>
                    <li><strong style="color:var(--text)">Loop continues</strong> (max 25 iterations). If the conversation approaches the 128K token limit, it is intelligently compacted using LLM-based summarization that preserves key facts, tool results, and decisions</li>
                    <li><strong style="color:var(--text)">On completion</strong>, the tool sequence is recorded in the learning system. If the session resolved an incident, the resolution pattern informs future recommendations</li>
                </ol>
            </div>

            <!-- Learning Loop -->
            <div class="card">
                <div class="card-title">The Learning Loop (How the Agent Improves)</div>
                <div style="font-size:13px;color:var(--text-dim);line-height:1.8;">
                    <p style="margin-bottom:12px;">The agent learns from every interaction through a closed feedback loop:</p>
                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:16px;">
                        <div style="background:var(--bg-input);padding:12px;border-radius:var(--radius-sm);border-left:3px solid var(--accent);">
                            <strong style="color:var(--text);display:block;margin-bottom:4px;">1. Record</strong>
                            Three channels feed resolution data: chat sessions (tool sequences the LLM chose), playbook executions (automated steps), and monitoring auto-recovery (service self-healed).
                        </div>
                        <div style="background:var(--bg-input);padding:12px;border-radius:var(--radius-sm);border-left:3px solid var(--green);">
                            <strong style="color:var(--text);display:block;margin-bottom:4px;">2. Embed</strong>
                            Each resolution and incident is embedded as a 1536-dimension vector (OpenAI text-embedding-3-small). Vectors are stored in H2 and loaded into an in-memory index for fast cosine similarity lookup.
                        </div>
                        <div style="background:var(--bg-input);padding:12px;border-radius:var(--radius-sm);border-left:3px solid var(--blue);">
                            <strong style="color:var(--text);display:block;margin-bottom:4px;">3. Feed Back</strong>
                            On the next chat session, the system prompt includes: top resolution patterns, per-service success rates, and semantic recommendations from similar problems ‚Äî even across different services.
                        </div>
                    </div>
                    <p><strong style="color:var(--text);">Cross-service transfer:</strong> When the agent resolves a MySQL timeout, that knowledge helps resolve a PostgreSQL timeout in the future, because the embeddings capture semantic similarity rather than relying on exact service name matches.</p>
                </div>
            </div>

            <!-- Human-in-the-Loop -->
            <div class="card">
                <div class="card-title">Human-in-the-Loop Controls</div>
                <div style="font-size:13px;color:var(--text-dim);line-height:1.8;">
                    <p style="margin-bottom:8px;">The agent is autonomous but not unsupervised. Humans stay in control at critical points:</p>
                    <p>&#x25B8; <strong style="color:var(--text)">Tool Approval</strong> ‚Äî Sensitive tools (service_restart, ssh_exec, playbook_run) require human approval. The approval list is configurable at runtime via the UI. The agentic loop pauses and auto-resumes once approved.</p>
                    <p>&#x25B8; <strong style="color:var(--text)">RCA Review</strong> ‚Äî After every resolved incident, the LLM generates a detailed Root Cause Analysis. It is sent for human review where the reviewer can edit, approve, or reject (with optional regeneration).</p>
                    <p>&#x25B8; <strong style="color:var(--text)">Playbook Suggestions</strong> ‚Äî When the AI identifies recurring patterns worth automating, it proposes new playbooks. Humans review, approve, or dismiss each suggestion before it becomes active.</p>
                    <p>&#x25B8; <strong style="color:var(--text)">Risk Assessment</strong> ‚Äî Proactive risk analysis runs every 30 minutes. Identified risks are surfaced on the dashboard for human triage ‚Äî the agent flags, the human decides.</p>
                </div>
            </div>

            <!-- Key Capabilities -->
            <div class="card">
                <div class="card-title">What Makes This Agent Different</div>
                <div style="font-size:13px;color:var(--text-dim);line-height:1.8;">
                    <p>&#x2726; <strong style="color:var(--text)">Autonomous &amp; Tool-Using</strong> ‚Äî 14 specialized SRE tools to interact with real infrastructure: health checks, Docker/Kubernetes management, SSH, service restarts, playbook execution, incident management, network diagnostics, and more</p>
                    <p>&#x2726; <strong style="color:var(--text)">Self-Improving</strong> ‚Äî Learns from every resolution across three channels. Success rates and tool patterns are tracked per service and fed back into the LLM's context. Suggests new playbooks from recurring patterns</p>
                    <p>&#x2726; <strong style="color:var(--text)">Semantic Memory</strong> ‚Äî Vector embeddings (OpenAI text-embedding-3-small) enable meaning-based search across incidents, resolutions, and RCA reports. Replaces expensive multi-LLM-call keyword search with fast cosine similarity</p>
                    <p>&#x2726; <strong style="color:var(--text)">LLM-Driven Intelligence</strong> ‚Äî Severity triage, incident search ranking, RCA generation, risk assessment, playbook suggestions, and conversation compaction are all powered by LLM reasoning, not hardcoded rules</p>
                    <p>&#x2726; <strong style="color:var(--text)">Proactive</strong> ‚Äî Monitoring runs in the background with per-service configurable intervals. Unhealthy services trigger LLM-classified incidents, auto-fire matching playbooks, and on recovery auto-generate RCA reports</p>
                    <p>&#x2726; <strong style="color:var(--text)">Human-in-the-Loop</strong> ‚Äî Approval workflow for sensitive tools, RCA review process, playbook suggestion approval, and risk triage keep humans in control of critical decisions</p>
                    <p>&#x2726; <strong style="color:var(--text)">Policy-Governed</strong> ‚Äî Profile-based tool access with runtime-toggleable approval requirements prevent unauthorized actions. Full audit trail of every tool execution and system event</p>
                </div>
            </div>
        </div>

        <!-- Agent Chat -->
        <div class="page" id="page-chat">
            <div class="page-header">
                <h2>Agent Chat</h2>
                <p>Talk to the SRE Agent ‚Äî it can investigate issues, run tools, and take actions</p>
            </div>
            <div class="chat-container">
                <div class="chat-messages" id="chat-messages">
                    <div class="chat-msg system">SRE Agent connected. Ask me to check health, investigate incidents, run playbooks, or diagnose issues.</div>
                </div>
                <div class="chat-input-area">
                    <input class="form-input" id="chat-input" placeholder="e.g. Check the health of all monitored services..." onkeydown="if(event.key==='Enter')sendChat()" style="flex:1;">
                    <button class="btn btn-primary" onclick="sendChat()">Send</button>
                    <button class="btn btn-secondary" onclick="newChatSession()" title="Start a new conversation">New Chat</button>
                </div>
            </div>
        </div>

        <!-- Tools -->
        <div class="page" id="page-tools">
            <div class="page-header">
                <h2>Agent Tools</h2>
                <p>All SRE tools available to the agent, filtered by the 9-layer policy engine</p>
            </div>
            <div class="tools-grid" id="tools-grid">
                <div class="empty-state"><div class="loading"></div><br>Loading tools...</div>
            </div>
        </div>

        <!-- Monitoring -->
        <div class="page" id="page-monitoring">
            <div class="page-header">
                <h2>Service Monitoring</h2>
                <p>Register services and monitor their health in real-time</p>
            </div>
            <div class="btn-group" style="margin-bottom:16px;">
                <button class="btn btn-primary" onclick="openModal('add-service-modal')">+ Add Service</button>
                <button class="btn btn-secondary" onclick="refreshServices()">‚Üª Refresh</button>
            </div>
            <div class="card">
                <div class="table-wrap"><table><thead><tr><th>Service</th><th>Type</th><th>Endpoint</th><th>Status</th><th>Enabled</th><th>Failures</th><th>Interval</th><th>Last Check</th><th>Actions</th></tr></thead><tbody id="monitoring-services"><tr><td colspan="9" class="empty-state">Loading...</td></tr></tbody></table></div>
            </div>
        </div>

        <!-- Incidents -->
        <div class="page" id="page-incidents">
            <div class="page-header">
                <h2>Incidents</h2>
                <p>Track and manage production incidents</p>
            </div>
            <div class="btn-group" style="margin-bottom:16px;">
                <button class="btn btn-primary" onclick="openModal('create-incident-modal')">+ Create Incident</button>
                <button class="btn btn-secondary" onclick="refreshIncidents()">‚Üª Refresh</button>
            </div>
            <div class="card">
                <div class="table-wrap"><table><thead><tr><th>Severity</th><th>Title</th><th>Service</th><th>Status</th><th>Escalation</th><th>Created</th><th>Actions</th></tr></thead><tbody id="incidents-table"><tr><td colspan="7" class="empty-state">Loading...</td></tr></tbody></table></div>
            </div>
        </div>

        <!-- Alert Rules -->
        <div class="page" id="page-alerts">
            <div class="page-header">
                <h2>Alert Rules</h2>
                <p>Define thresholds and conditions for automated alerting</p>
            </div>
            <div class="btn-group" style="margin-bottom:16px;">
                <button class="btn btn-primary" onclick="openModal('create-alert-modal')">+ Create Alert Rule</button>
                <button class="btn btn-secondary" onclick="refreshAlerts()">‚Üª Refresh</button>
            </div>
            <div class="card">
                <div class="table-wrap"><table><thead><tr><th>Name</th><th>Metric</th><th>Condition</th><th>Severity</th><th>Enabled</th><th>Triggered</th><th>Actions</th></tr></thead><tbody id="alerts-table"><tr><td colspan="7" class="empty-state">Loading...</td></tr></tbody></table></div>
            </div>
        </div>

        <!-- Playbooks -->
        <div class="page" id="page-playbooks">
            <div class="page-header">
                <h2>Playbooks</h2>
                <p>Automated remediation runbooks stored in the database</p>
            </div>
            <div class="btn-group" style="margin-bottom:16px;">
                <button class="btn btn-primary" onclick="openPlaybookModal()">+ Create Playbook</button>
                <button class="btn btn-secondary" onclick="loadPlaybooks()">‚Üª Reload</button>
                <button class="btn btn-secondary" id="btn-generate-ai" onclick="generateAiSuggestions()">üß† Generate AI Suggestions</button>
            </div>

            <!-- AI Suggestions Section -->
            <div id="suggestions-section" style="display:none; margin-bottom:20px;">
                <h3 style="margin-bottom:8px;">ü§ñ AI Suggestions <span class="badge" id="inline-suggestion-badge">0</span></h3>
                <p style="color:var(--text-secondary); font-size:0.85rem; margin-bottom:12px;">Based on recurring resolution patterns, the agent suggests these new playbooks:</p>
                <div id="suggestions-list"></div>
            </div>

            <h3 style="margin-bottom:12px;">Available Playbooks</h3>
            <div class="card">
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Triggers</th>
                                <th>Steps</th>
                                <th>Approval</th>
                                <th>Enabled</th>
                                <th>Source</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="playbooks-table">
                            <tr><td colspan="7" class="empty-state">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Learnings -->
        <div class="page" id="page-learnings">
            <div class="page-header">
                <h2>Learnings</h2>
                <p>Resolution records captured from incidents, playbooks, and monitoring. Edit or add manual learnings to improve the agent.</p>
            </div>

            <!-- Executive Summary -->
            <div class="card" id="learning-exec-summary-card" style="margin-bottom:20px;padding:20px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                    <h3 style="margin:0;font-size:16px;">Executive Summary</h3>
                    <button class="btn btn-secondary" id="learning-exec-refresh-btn" onclick="refreshLearningExecSummary()" style="font-size:12px;padding:4px 12px;">Refresh</button>
                </div>
                <div id="learning-exec-summary-content" style="white-space:pre-wrap;font-size:13px;line-height:1.6;color:var(--text);">
                    No summary generated yet. Click Refresh to generate.
                </div>
                <div id="learning-exec-summary-time" style="font-size:11px;color:var(--text-dim);margin-top:10px;"></div>
            </div>

            <!-- Summary Cards -->
            <div id="learnings-summary" style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px;">
                <div class="card" style="text-align:center;padding:16px;">
                    <div style="font-size:24px;font-weight:700;" id="lr-total">0</div>
                    <div style="font-size:11px;color:var(--text-dim)">Total Records</div>
                </div>
                <div class="card" style="text-align:center;padding:16px;">
                    <div style="font-size:24px;font-weight:700;color:var(--green);" id="lr-successful">0</div>
                    <div style="font-size:11px;color:var(--text-dim)">Successful</div>
                </div>
                <div class="card" style="text-align:center;padding:16px;">
                    <div style="font-size:24px;font-weight:700;color:var(--accent);" id="lr-rate">0%</div>
                    <div style="font-size:11px;color:var(--text-dim)">Success Rate</div>
                </div>
                <div class="card" style="text-align:center;padding:16px;">
                    <div style="font-size:24px;font-weight:700;color:var(--text);" id="lr-avg-time">-</div>
                    <div style="font-size:11px;color:var(--text-dim)">Avg Resolution</div>
                </div>
            </div>

            <!-- Filter Bar + Add Button -->
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;flex-wrap:wrap;">
                <button class="btn btn-primary" onclick="openLearningModal()">+ Add Learning</button>
                <select class="form-select" id="lr-filter-service" onchange="loadLearnings()" style="width:200px;">
                    <option value="">All Services</option>
                </select>
                <select class="form-select" id="lr-filter-success" onchange="filterLearningsTable()" style="width:150px;">
                    <option value="">All Results</option>
                    <option value="true">Successful</option>
                    <option value="false">Failed</option>
                </select>
                <button class="btn btn-secondary" onclick="loadLearnings()">‚Üª Refresh</button>
            </div>

            <!-- Records Table -->
            <div style="overflow-x:auto;">
                <table id="learnings-table" style="width:100%;">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Service</th>
                            <th>Incident</th>
                            <th>Tool Sequence</th>
                            <th>Result</th>
                            <th>Time</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="learnings-tbody">
                        <tr><td colspan="7" style="text-align:center;padding:24px;color:var(--text-dim);">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Live Events -->
        <div class="page" id="page-events">
            <div class="page-header">
                <h2>Live Events</h2>
                <p>Real-time WebSocket event stream from the gateway</p>
            </div>
            <div class="card">
                <div class="card-title">WebSocket Events</div>
                <div class="event-log" id="event-log">
                    <div style="color:var(--text-dim)">Waiting for events...</div>
                </div>
            </div>
            <div class="card" style="margin-top:16px;">
                <div class="card-title">Send RPC Command</div>
                <div class="form-inline">
                    <select class="form-select" id="rpc-method" style="width:220px;">
                        <option value="gateway.status">gateway.status</option>
                        <option value="gateway.methods">gateway.methods</option>
                        <option value="monitor.health">monitor.health</option>
                        <option value="monitor.services">monitor.services</option>
                        <option value="incident.list">incident.list</option>
                        <option value="playbook.list">playbook.list</option>
                        <option value="tool.list">tool.list</option>
                        <option value="plugin.list">plugin.list</option>
                    </select>
                    <button class="btn btn-primary" onclick="sendRpc()">Send RPC</button>
                </div>
                <pre id="rpc-result" style="margin-top:12px;background:var(--bg);padding:12px;border-radius:var(--radius-sm);font-size:12px;font-family:var(--mono);max-height:300px;overflow:auto;color:var(--text-dim);">Results will appear here...</pre>
            </div>
        </div>

        <!-- Pending Approvals -->
        <div class="page" id="page-approvals">
            <div class="page-header">
                <h2>Pending Approvals</h2>
                <p>Tools requiring human confirmation before execution</p>
            </div>
            <div class="btn-group" style="margin-bottom:16px;">
                <button class="btn btn-secondary" onclick="refreshApprovals()">‚Üª Refresh</button>
            </div>
            <div class="card">
                <div class="table-wrap"><table><thead><tr><th>Tool</th><th>Parameters</th><th>Session</th><th>Requested</th><th>Status</th><th>Actions</th></tr></thead><tbody id="approvals-table"><tr><td colspan="6" class="empty-state">Loading...</td></tr></tbody></table></div>
            </div>
        </div>

        <!-- Audit Log -->
        <div class="page" id="page-audit">
            <div class="page-header">
                <h2>Audit Log</h2>
                <p>Complete trail of all agent actions, incidents, playbooks, and system events</p>
            </div>
            <div class="btn-group" style="margin-bottom:16px;">
                <select class="form-select" id="audit-actor-filter" style="width:150px;" onchange="refreshAuditLog()">
                    <option value="">All Actors</option>
                    <option value="agent">Agent</option>
                    <option value="user">User</option>
                    <option value="system">System</option>
                    <option value="monitoring">Monitoring</option>
                    <option value="playbook-engine">Playbook Engine</option>
                </select>
                <select class="form-select" id="audit-action-filter" style="width:200px;" onchange="refreshAuditLog()">
                    <option value="">All Actions</option>
                    <option value="TOOL_EXECUTED">Tool Executed</option>
                    <option value="INCIDENT_CREATED">Incident Created</option>
                    <option value="INCIDENT_RESOLVED">Incident Resolved</option>
                    <option value="PLAYBOOK_RUN">Playbook Run</option>
                    <option value="PLAYBOOK_COMPLETED">Playbook Completed</option>
                    <option value="APPROVAL_REQUESTED">Approval Requested</option>
                    <option value="APPROVAL_GRANTED">Approval Granted</option>
                    <option value="APPROVAL_DENIED">Approval Denied</option>
                    <option value="ESCALATION">Escalation</option>
                    <option value="RESOLUTION_RECORDED">Resolution Recorded</option>
                    <option value="PLAYBOOK_GENERATED">Playbook Generated</option>
                </select>
                <button class="btn btn-secondary" onclick="refreshAuditLog()">‚Üª Refresh</button>
            </div>
            <div class="card">
                <div class="table-wrap"><table><thead><tr><th>Timestamp</th><th>Actor</th><th>Action</th><th>Target</th><th>Success</th><th>Details</th></tr></thead><tbody id="audit-table"><tr><td colspan="6" class="empty-state">Loading...</td></tr></tbody></table></div>
            </div>
        </div>

        <!-- Security Audit -->
        <div class="page" id="page-security">
            <div class="page-header">
                <h2>Security Audit</h2>
                <p>Automated security checks for configuration and policy</p>
            </div>
            <div class="btn-group" style="margin-bottom:16px;">
                <button class="btn btn-primary" onclick="runSecurityAudit()">Run Audit</button>
            </div>
            <div id="security-findings"><div class="empty-state">Click "Run Audit" to check your configuration</div></div>
        </div>

        <!-- RCA Reports -->
        <div class="page" id="page-rca">
            <div class="page-header">
                <h2>RCA Reports</h2>
                <p>Root Cause Analysis reports generated after incident resolution ‚Äî review, edit, and approve</p>
            </div>
            <!-- RCA Executive Summary -->
            <div class="card" id="rca-exec-summary-card" style="margin-bottom:20px;padding:20px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                    <h3 style="margin:0;font-size:16px;">Executive Summary</h3>
                    <button class="btn btn-secondary" id="rca-exec-refresh-btn" onclick="refreshRcaExecSummary()" style="font-size:12px;padding:4px 12px;">Refresh</button>
                </div>
                <div id="rca-exec-summary-content" style="white-space:pre-wrap;font-size:13px;line-height:1.6;color:var(--text);">
                    No summary generated yet. Click Refresh to generate.
                </div>
                <div id="rca-exec-summary-time" style="font-size:11px;color:var(--text-dim);margin-top:10px;"></div>
            </div>

            <div class="stat-grid" id="rca-stats">
                <div class="stat-card"><div class="stat-icon blue">üìÑ</div><div><div class="stat-value" id="rca-stat-total">0</div><div class="stat-label">Total RCAs</div></div></div>
                <div class="stat-card"><div class="stat-icon yellow">‚è≥</div><div><div class="stat-value" id="rca-stat-pending">0</div><div class="stat-label">Pending Review</div></div></div>
                <div class="stat-card"><div class="stat-icon green">‚úÖ</div><div><div class="stat-value" id="rca-stat-approved">0</div><div class="stat-label">Approved</div></div></div>
                <div class="stat-card"><div class="stat-icon red">‚ùå</div><div><div class="stat-value" id="rca-stat-rejected">0</div><div class="stat-label">Rejected</div></div></div>
            </div>
            <div class="btn-group" style="margin-bottom:16px;">
                <button class="btn btn-secondary" onclick="loadRcaReports()">‚Üª Refresh</button>
                <select id="rca-filter-status" class="form-input" style="width:auto;display:inline-block;" onchange="loadRcaReports()">
                    <option value="">All Statuses</option>
                    <option value="PENDING_REVIEW">Pending Review</option>
                    <option value="APPROVED">Approved</option>
                    <option value="REJECTED">Rejected</option>
                    <option value="GENERATING">Generating</option>
                </select>
            </div>
            <div class="card">
                <div class="table-wrap">
                    <table>
                        <thead><tr><th>Service</th><th>Incident</th><th>Severity</th><th>Status</th><th>Resolution Time</th><th>Generated</th><th>Actions</th></tr></thead>
                        <tbody id="rca-table"><tr><td colspan="7" class="empty-state">Loading...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Risk Assessment Page -->
        <div class="page" id="page-risks">
            <div class="page-header">
                <h2>Risk Assessment</h2>
                <p>Proactive risk analysis powered by LLM ‚Äî identifies emerging threats before they become incidents</p>
            </div>
            <div class="stat-grid" id="risk-stats">
                <div class="stat-card"><div class="stat-icon yellow">‚ö†Ô∏è</div><div><div class="stat-value" id="risk-stat-open">0</div><div class="stat-label">Open Risks</div></div></div>
                <div class="stat-card"><div class="stat-icon blue">üëÅÔ∏è</div><div><div class="stat-value" id="risk-stat-acknowledged">0</div><div class="stat-label">Acknowledged</div></div></div>
                <div class="stat-card"><div class="stat-icon green">‚úÖ</div><div><div class="stat-value" id="risk-stat-mitigated">0</div><div class="stat-label">Mitigated</div></div></div>
                <div class="stat-card"><div class="stat-icon red">üî¥</div><div><div class="stat-value" id="risk-stat-critical">0</div><div class="stat-label">Critical/High</div></div></div>
            </div>
            <div class="btn-group" style="margin-bottom:16px;">
                <button class="btn btn-primary" onclick="triggerRiskAnalysis()">üîç Run Analysis Now</button>
                <button class="btn btn-secondary" onclick="loadRisks()">‚Üª Refresh</button>
                <select id="risk-filter-status" class="form-input" style="width:auto;display:inline-block;" onchange="loadRisks()">
                    <option value="">All Statuses</option>
                    <option value="OPEN">Open</option>
                    <option value="ACKNOWLEDGED">Acknowledged</option>
                    <option value="MITIGATED">Mitigated</option>
                </select>
            </div>
            <div class="card">
                <div class="table-wrap">
                    <table>
                        <thead><tr><th>Severity</th><th>Risk</th><th>Service</th><th>Category</th><th>Status</th><th>Identified</th><th>Actions</th></tr></thead>
                        <tbody id="risk-table"><tr><td colspan="7" class="empty-state">Loading...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>
</div>

<!-- ‚îÄ‚îÄ‚îÄ Modals ‚îÄ‚îÄ‚îÄ -->
<div class="modal-overlay" id="add-service-modal">
    <div class="modal">
        <h3>Register Service for Monitoring</h3>
        <div class="form-group"><label class="form-label">Service Name</label><input class="form-input" id="svc-name" placeholder="e.g. payment-service"></div>
        <div class="form-group"><label class="form-label">Display Name</label><input class="form-input" id="svc-display" placeholder="e.g. Payment Service"></div>
        <div class="form-row">
            <div class="form-group"><label class="form-label">Type</label><select class="form-select" id="svc-type"><option>HTTP</option><option>TCP</option><option>KUBERNETES_DEPLOYMENT</option><option>KUBERNETES_STATEFULSET</option><option>DOCKER_CONTAINER</option><option>PROCESS</option></select></div>
            <div class="form-group"><label class="form-label">Check Interval (sec)</label><input class="form-input" id="svc-interval" type="number" value="60"></div>
        </div>
        <div class="form-group"><label class="form-label">Health Endpoint</label><input class="form-input" id="svc-endpoint" placeholder="http://localhost:8080/actuator/health"></div>
        <div class="form-group"><label class="form-label">Metrics Endpoint</label><input class="form-input" id="svc-metrics" placeholder="http://localhost:8080/actuator/prometheus"></div>
        <div class="form-group"><label class="form-label">Log Source</label><input class="form-input" id="svc-logsource" placeholder="e.g. journalctl, kubectl, docker, /var/log/app.log"></div>
        <div class="form-row">
            <div class="form-group"><label class="form-label">Namespace</label><input class="form-input" id="svc-namespace" placeholder="default"></div>
            <div class="form-group"><label class="form-label">Cluster</label><input class="form-input" id="svc-cluster" placeholder="production"></div>
        </div>
        <div class="btn-group" style="margin-top:16px;justify-content:flex-end;">
            <button class="btn btn-secondary" onclick="closeModal('add-service-modal')">Cancel</button>
            <button class="btn btn-primary" onclick="addService()">Register Service</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="edit-service-modal">
    <div class="modal">
        <h3>Edit Service Configuration</h3>
        <input type="hidden" id="edit-svc-id">
        <div class="form-group"><label class="form-label">Service Name</label><input class="form-input" id="edit-svc-name" placeholder="e.g. payment-service"></div>
        <div class="form-group"><label class="form-label">Display Name</label><input class="form-input" id="edit-svc-display" placeholder="e.g. Payment Service"></div>
        <div class="form-row">
            <div class="form-group"><label class="form-label">Type</label><select class="form-select" id="edit-svc-type"><option>HTTP</option><option>TCP</option><option>KUBERNETES_DEPLOYMENT</option><option>KUBERNETES_STATEFULSET</option><option>DOCKER_CONTAINER</option><option>PROCESS</option></select></div>
            <div class="form-group"><label class="form-label">Check Interval (sec)</label><input class="form-input" id="edit-svc-interval" type="number" value="60"></div>
        </div>
        <div class="form-group"><label class="form-label">Health Endpoint</label><input class="form-input" id="edit-svc-endpoint" placeholder="http://localhost:8080/actuator/health"></div>
        <div class="form-group"><label class="form-label">Metrics Endpoint</label><input class="form-input" id="edit-svc-metrics" placeholder="http://localhost:8080/actuator/prometheus"></div>
        <div class="form-group"><label class="form-label">Log Source</label><input class="form-input" id="edit-svc-logsource" placeholder="e.g. journalctl, kubectl, docker, /var/log/app.log"></div>
        <div class="form-row">
            <div class="form-group"><label class="form-label">Namespace</label><input class="form-input" id="edit-svc-namespace" placeholder="default"></div>
            <div class="form-group"><label class="form-label">Cluster</label><input class="form-input" id="edit-svc-cluster" placeholder="production"></div>
        </div>
        <div class="form-group" style="display:flex;align-items:center;gap:10px;">
            <label class="form-label" style="margin-bottom:0;">Enabled</label>
            <input type="checkbox" id="edit-svc-enabled" checked style="width:18px;height:18px;accent-color:var(--accent);">
        </div>
        <div class="btn-group" style="margin-top:16px;justify-content:flex-end;">
            <button class="btn btn-secondary" onclick="closeModal('edit-service-modal')">Cancel</button>
            <button class="btn btn-primary" onclick="updateService()">Save Changes</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="create-incident-modal">
    <div class="modal">
        <h3>Create Incident</h3>
        <div class="form-group"><label class="form-label">Title</label><input class="form-input" id="inc-title" placeholder="e.g. High latency on payment service"></div>
        <div class="form-row">
            <div class="form-group"><label class="form-label">Severity</label><select class="form-select" id="inc-severity"><option>CRITICAL</option><option>HIGH</option><option selected>MEDIUM</option><option>LOW</option><option>INFO</option></select></div>
            <div class="form-group"><label class="form-label">Service</label><input class="form-input" id="inc-service" placeholder="payment-service"></div>
        </div>
        <div class="form-group"><label class="form-label">Description</label><textarea class="form-textarea" id="inc-desc" placeholder="Describe the incident..."></textarea></div>
        <div class="btn-group" style="margin-top:16px;justify-content:flex-end;">
            <button class="btn btn-secondary" onclick="closeModal('create-incident-modal')">Cancel</button>
            <button class="btn btn-primary" onclick="createIncident()">Create Incident</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="create-alert-modal">
    <div class="modal">
        <h3>Create Alert Rule</h3>
        <div class="form-group"><label class="form-label">Rule Name</label><input class="form-input" id="alert-name" placeholder="e.g. High Error Rate"></div>
        <div class="form-row">
            <div class="form-group"><label class="form-label">Metric</label><input class="form-input" id="alert-metric" placeholder="e.g. http_errors_total"></div>
            <div class="form-group"><label class="form-label">Condition</label><select class="form-select" id="alert-condition"><option>GREATER_THAN</option><option>LESS_THAN</option><option>EQUALS</option><option>NOT_EQUALS</option><option>RATE_INCREASE</option><option>ABSENT</option></select></div>
        </div>
        <div class="form-row">
            <div class="form-group"><label class="form-label">Threshold</label><input class="form-input" id="alert-threshold" type="number" placeholder="100"></div>
            <div class="form-group"><label class="form-label">Severity</label><select class="form-select" id="alert-severity"><option>CRITICAL</option><option>HIGH</option><option selected>MEDIUM</option><option>LOW</option></select></div>
        </div>
        <div class="form-row">
            <div class="form-group"><label class="form-label">Service</label><input class="form-input" id="alert-service" placeholder="payment-service"></div>
            <div class="form-group"><label class="form-label">Duration (sec)</label><input class="form-input" id="alert-duration" type="number" value="300"></div>
        </div>
        <div class="btn-group" style="margin-top:16px;justify-content:flex-end;">
            <button class="btn btn-secondary" onclick="closeModal('create-alert-modal')">Cancel</button>
            <button class="btn btn-primary" onclick="createAlert()">Create Alert</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="create-playbook-modal">
    <div class="modal" style="max-width:720px;">
        <h3 id="pb-modal-title">Create Playbook</h3>
        <input type="hidden" id="pb-edit-id" value="">
        <div class="form-row">
            <div class="form-group" style="flex:2"><label class="form-label">Playbook Name</label><input class="form-input" id="pb-name" placeholder="e.g. Docker Service Restart"></div>
            <div class="form-group"><label class="form-label">Author</label><input class="form-input" id="pb-author" placeholder="user" value="user"></div>
        </div>
        <div class="form-group"><label class="form-label">Description</label><textarea class="form-textarea" id="pb-description" placeholder="Describe what this playbook does and when to use it..."></textarea></div>
        <div class="form-row">
            <div class="form-group"><label class="form-label">Tags (comma-separated)</label><input class="form-input" id="pb-tags" placeholder="docker, restart, remediation"></div>
            <div class="form-group" style="flex:0;min-width:200px;display:flex;align-items:flex-end;gap:16px;">
                <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:0.85rem;">
                    <input type="checkbox" id="pb-approval"> Approval required
                </label>
                <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:0.85rem;">
                    <input type="checkbox" id="pb-enabled" checked> Enabled
                </label>
            </div>
        </div>
        <h4 style="margin:12px 0 6px;">Trigger Conditions</h4>
        <div class="form-row" style="margin-bottom:4px;">
            <div class="form-group"><label class="form-label">Trigger Type</label>
                <select class="form-select" id="pb-trigger-type">
                    <option value="service_unhealthy">service_unhealthy</option>
                    <option value="incident_severity">incident_severity</option>
                    <option value="manual">manual</option>
                </select>
            </div>
            <div class="form-group"><label class="form-label">Trigger Service</label><input class="form-input" id="pb-trigger-service" placeholder="e.g. my-app or * for any"></div>
        </div>
        <div class="form-group">
            <label class="form-label">Trigger Severities</label>
            <div style="display:flex;gap:16px;flex-wrap:wrap;padding:4px 0;">
                <label style="display:flex;align-items:center;gap:4px;cursor:pointer;font-size:0.85rem;">
                    <input type="checkbox" class="pb-sev-cb" value="LOW"> LOW
                </label>
                <label style="display:flex;align-items:center;gap:4px;cursor:pointer;font-size:0.85rem;">
                    <input type="checkbox" class="pb-sev-cb" value="MEDIUM"> MEDIUM
                </label>
                <label style="display:flex;align-items:center;gap:4px;cursor:pointer;font-size:0.85rem;">
                    <input type="checkbox" class="pb-sev-cb" value="HIGH" checked> HIGH
                </label>
                <label style="display:flex;align-items:center;gap:4px;cursor:pointer;font-size:0.85rem;">
                    <input type="checkbox" class="pb-sev-cb" value="CRITICAL" checked> CRITICAL
                </label>
                <label style="display:flex;align-items:center;gap:4px;cursor:pointer;font-size:0.85rem;">
                    <input type="checkbox" class="pb-sev-cb" value="*"> Any (*)
                </label>
            </div>
        </div>
        <h4 style="margin:12px 0 8px;">Steps</h4>
        <div id="pb-steps-list"></div>
        <button class="btn btn-secondary" onclick="addPlaybookStep()" style="margin-top:8px;">+ Add Step</button>
        <div class="btn-group" style="margin-top:16px;justify-content:flex-end;">
            <button class="btn btn-secondary" onclick="closeModal('create-playbook-modal'); resetPlaybookForm()">Cancel</button>
            <button class="btn btn-primary" onclick="savePlaybook()">Save Playbook</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="learning-modal">
    <div class="modal" style="max-width:600px;">
        <h3 id="learning-modal-title">Add Learning Record</h3>
        <input type="hidden" id="lr-edit-id" value="">
        <div class="form-row">
            <div class="form-group" style="flex:1"><label class="form-label">Service Name</label><input class="form-input" id="lr-service" placeholder="e.g. local-mysql"></div>
            <div class="form-group" style="flex:1"><label class="form-label">Incident ID (optional)</label><input class="form-input" id="lr-incident-id" placeholder="e.g. abc-123"></div>
        </div>
        <div class="form-group"><label class="form-label">Incident Title</label><input class="form-input" id="lr-title" placeholder="e.g. Service unhealthy: local-mysql"></div>
        <div class="form-group"><label class="form-label">Tool Sequence (comma-separated)</label><input class="form-input" id="lr-tools" placeholder="e.g. health_check, docker_exec, service_restart"></div>
        <div class="form-row">
            <div class="form-group"><label class="form-label">Resolution Time (seconds)</label><input class="form-input" id="lr-time" type="number" value="0" min="0"></div>
            <div class="form-group" style="flex:0;min-width:150px;display:flex;align-items:flex-end;">
                <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:0.85rem;">
                    <input type="checkbox" id="lr-success" checked> Successful resolution
                </label>
            </div>
        </div>
        <div class="btn-group" style="margin-top:16px;justify-content:flex-end;">
            <button class="btn btn-secondary" onclick="closeModal('learning-modal')">Cancel</button>
            <button class="btn btn-primary" onclick="saveLearning()">Save</button>
        </div>
    </div>
</div>

<!-- RCA Review Modal -->
<div class="modal-overlay" id="rca-review-modal">
    <div class="modal" style="max-width:900px;">
        <h3 id="rca-modal-title">RCA Report</h3>
        <input type="hidden" id="rca-edit-id" value="">
        <!-- Read-only incident header -->
        <div style="display:flex;gap:16px;margin-bottom:16px;padding:12px;background:var(--bg-sidebar);border-radius:var(--radius);font-size:13px;">
            <div><strong>Incident:</strong> <span id="rca-hdr-incident"></span></div>
            <div><strong>Service:</strong> <span id="rca-hdr-service"></span></div>
            <div><strong>Severity:</strong> <span id="rca-hdr-severity"></span></div>
            <div><strong>Resolution Time:</strong> <span id="rca-hdr-time"></span></div>
            <div><strong>Tools Used:</strong> <span id="rca-hdr-tools"></span></div>
        </div>
        <!-- Editable RCA sections -->
        <div class="form-group"><label class="form-label">Executive Summary</label>
            <textarea class="form-input" id="rca-summary" rows="3" placeholder="One-paragraph summary of what happened..."></textarea>
        </div>
        <div class="form-group"><label class="form-label">Timeline</label>
            <textarea class="form-input" id="rca-timeline" rows="5" placeholder="Chronological event timeline..."></textarea>
        </div>
        <div class="form-group"><label class="form-label">Root Cause</label>
            <textarea class="form-input" id="rca-rootcause" rows="4" placeholder="Identified root cause with technical details..."></textarea>
        </div>
        <div class="form-group"><label class="form-label">Impact</label>
            <textarea class="form-input" id="rca-impact" rows="3" placeholder="Scope and user/business impact..."></textarea>
        </div>
        <div class="form-group"><label class="form-label">Resolution Steps</label>
            <textarea class="form-input" id="rca-resolution" rows="4" placeholder="Steps taken to resolve the incident..."></textarea>
        </div>
        <div class="form-group"><label class="form-label">Lessons Learned</label>
            <textarea class="form-input" id="rca-lessons" rows="3" placeholder="Key takeaways from this incident..."></textarea>
        </div>
        <div class="form-group"><label class="form-label">Preventive Measures</label>
            <textarea class="form-input" id="rca-preventive" rows="3" placeholder="Action items to prevent recurrence..."></textarea>
        </div>
        <div class="form-group"><label class="form-label">Reviewer Notes (optional)</label>
            <textarea class="form-input" id="rca-review-notes" rows="2" placeholder="Your comments or notes about this RCA..."></textarea>
        </div>
        <div id="rca-modal-status" style="margin-bottom:8px;font-size:13px;color:var(--text-secondary);"></div>
        <div class="btn-group" style="margin-top:16px;justify-content:flex-end;">
            <button class="btn btn-secondary" onclick="closeModal('rca-review-modal')">Close</button>
            <button class="btn btn-secondary" id="rca-btn-regenerate" onclick="regenerateRca()" style="display:none;">Regenerate</button>
            <button class="btn btn-danger" id="rca-btn-reject" onclick="rejectRca()" style="display:none;">Reject</button>
            <button class="btn btn-primary" id="rca-btn-approve" onclick="approveRca()" style="display:none;">Approve</button>
            <button class="btn btn-primary" id="rca-btn-save" onclick="saveRcaEdits()" style="display:none;">Save Edits</button>
        </div>
    </div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ Config ‚îÄ‚îÄ‚îÄ
const API = '';
let ws = null;
let rpcId = 0;

// ‚îÄ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ‚îÄ
document.querySelectorAll('.nav-item[data-page]').forEach(item => {
    item.addEventListener('click', () => {
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        item.classList.add('active');
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById('page-' + item.dataset.page).classList.add('active');
    });
});

// ‚îÄ‚îÄ‚îÄ Modal ‚îÄ‚îÄ‚îÄ
function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }
document.querySelectorAll('.modal-overlay').forEach(o => o.addEventListener('click', e => { if (e.target === o) o.classList.remove('active'); }));

// ‚îÄ‚îÄ‚îÄ API Helpers ‚îÄ‚îÄ‚îÄ
async function api(path, opts = {}) {
    try {
        const res = await fetch(API + path, { headers: { 'Content-Type': 'application/json' }, ...opts });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
    } catch (e) { console.error('API error:', path, e); return null; }
}

// ‚îÄ‚îÄ‚îÄ WebSocket ‚îÄ‚îÄ‚îÄ
function connectWs() {
    const proto = location.protocol === 'https:' ? 'wss' : 'ws';
    ws = new WebSocket(`${proto}://${location.host}/ws/gateway`);
    ws.onopen = () => {
        document.getElementById('ws-dot').classList.add('connected');
        document.getElementById('ws-label').textContent = 'Connected';
        addEvent('system', 'WebSocket connected to gateway');
    };
    ws.onclose = () => {
        document.getElementById('ws-dot').classList.remove('connected');
        document.getElementById('ws-label').textContent = 'Disconnected';
        addEvent('system', 'WebSocket disconnected ‚Äî reconnecting in 3s...');
        setTimeout(connectWs, 3000);
    };
    ws.onmessage = (e) => {
        try {
            const msg = JSON.parse(e.data);
            if (msg.method) {
                addEvent(msg.method, JSON.stringify(msg.params || {}));
                handleBroadcast(msg);
            }
            if (msg.id && rpcCallbacks[msg.id]) {
                rpcCallbacks[msg.id](msg);
                delete rpcCallbacks[msg.id];
            }
        } catch (err) { console.error('WS parse error', err); }
    };
}
const rpcCallbacks = {};
function sendWsRpc(method, params) {
    return new Promise(resolve => {
        const id = String(++rpcId);
        rpcCallbacks[id] = resolve;
        ws.send(JSON.stringify({ jsonrpc: '2.0', id, method, params }));
    });
}

function handleBroadcast(msg) {
    if (msg.method === 'monitor.health_update' || msg.method === 'monitor.service_recovered') refreshDashboard();
    if (msg.method === 'incident.created' || msg.method === 'alert.triggered') { refreshDashboard(); refreshIncidents(); }
    if (msg.method === 'incident.escalated') { refreshIncidents(); }
    if (msg.method === 'playbook.completed') { addEvent(msg.method, `Playbook finished: ${msg.params?.status}`); }
    if (msg.method === 'approval.requested') {
        refreshApprovals();
        // Notify in chat that approval is needed
        const p = msg.params || {};
        appendChat('system', `Approval required for tool <strong>${p.tool_name || '?'}</strong>. Go to the Approvals page to approve or deny.`);
    }
    if (msg.method === 'approval.responded') {
        refreshApprovals();
        const p = msg.params || {};
        if (p.approved) {
            appendChat('system', `Tool <strong>${p.tool_name || '?'}</strong> approved by ${p.responded_by || 'user'}. Agent is auto-resuming...`);
        } else {
            appendChat('system', `Tool <strong>${p.tool_name || '?'}</strong> denied by ${p.responded_by || 'user'}.`);
        }
    }
    if (msg.method === 'agent.response') {
        const p = msg.params || {};
        if (p.response) {
            // Remove any lingering "Thinking..." indicator
            const thinkingEl = document.getElementById('chat-thinking');
            if (thinkingEl) thinkingEl.remove();
            let text = p.response;
            if (p.tools_used && p.tools_used.length > 0) text += `\n\nüîß Tools used: ${p.tools_used.join(', ')}`;
            appendChat('assistant', formatResponse(text));
        }
    }
    if (msg.method === 'rca.generated') {
        loadRcaReports();
        refreshRcaBadge();
        const p = msg.params || {};
        appendChat('system', `üìÑ RCA generated for incident <strong>${p.incident_title || p.incident_id || '?'}</strong> ‚Äî <a href="#" onclick="event.preventDefault();document.querySelector('[data-page=rca]').click();openRcaModal('${p.rca_id}');">Review now</a>`);
    }
    if (msg.method === 'rca.approved') {
        loadRcaReports();
        refreshRcaBadge();
    }
    if (msg.method === 'risk.identified') {
        loadRisks();
        refreshRiskBadge();
        loadDashboardRisks();
        const p = msg.params || {};
        appendChat('system', `‚ö†Ô∏è New risk identified: <strong>[${p.severity}]</strong> ${p.title || '?'} ‚Äî Service: ${p.service || 'system-wide'}. <a href="#" onclick="event.preventDefault();document.querySelector('[data-page=risks]').click();">View risks</a>`);
    }
}

// ‚îÄ‚îÄ‚îÄ Event Log ‚îÄ‚îÄ‚îÄ
function addEvent(method, data) {
    const log = document.getElementById('event-log');
    const first = log.querySelector('div:first-child');
    if (first && first.textContent.includes('Waiting for')) first.remove();
    const t = new Date().toLocaleTimeString();
    const entry = document.createElement('div');
    entry.className = 'event-entry';
    entry.innerHTML = `<span class="event-time">${t}</span><span class="event-method">${method}</span><span class="event-data">${data.substring(0, 300)}</span>`;
    log.prepend(entry);
    if (log.children.length > 200) log.lastChild.remove();
}

// ‚îÄ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ‚îÄ
async function refreshDashboard() {
    const [status, incidents, riskCounts] = await Promise.all([
        api('/api/gateway/status'),
        api('/api/incidents/active'),
        api('/api/risks/counts')
    ]);
    if (status) {
        const m = status.monitoring || {};
        document.getElementById('stat-healthy').textContent = m.healthy ?? 0;
        document.getElementById('stat-unhealthy').textContent = m.unhealthy ?? 0;
        document.getElementById('stat-incidents').textContent = status.incidents?.active ?? 0;
        document.getElementById('stat-tools').textContent = status.agent?.tools_registered ?? 0;
        document.getElementById('stat-risks').textContent = riskCounts?.open ?? 0;

        const badge = document.getElementById('incident-badge');
        const activeCount = status.incidents?.active ?? 0;
        if (activeCount > 0) { badge.textContent = activeCount; badge.style.display = ''; }
        else { badge.style.display = 'none'; }

        // Service table
        const services = m.services || [];
        const tbody = document.getElementById('dashboard-services');
        if (services.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="empty-state">No services registered. Go to Monitoring to add one.</td></tr>'; }
        else {
            tbody.innerHTML = services.map(s => `<tr>
                <td><strong>${s.name}</strong></td>
                <td><span class="tag">${s.type || 'HTTP'}</span></td>
                <td><span class="badge-status badge-${s.status?.toLowerCase()}">${s.status}</span></td>
                <td style="color:var(--text-dim);font-size:12px">${s.lastCheck === 'never' ? 'Never' : new Date(s.lastCheck).toLocaleTimeString()}</td>
            </tr>`).join('');
        }
    }
    // Incidents table
    if (incidents) {
        const tbody = document.getElementById('dashboard-incidents');
        if (incidents.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="empty-state">No active incidents</td></tr>'; }
        else {
            tbody.innerHTML = incidents.slice(0, 8).map(i => `<tr>
                <td><span class="badge-status badge-${i.severity?.toLowerCase()}">${i.severity}</span></td>
                <td>${i.title}</td>
                <td>${i.service || '-'}</td>
                <td><span class="badge-status badge-${i.status?.toLowerCase()}">${i.status}</span></td>
            </tr>`).join('');
        }
    }
}

// ‚îÄ‚îÄ‚îÄ Monitoring ‚îÄ‚îÄ‚îÄ
let servicesCache = [];
async function refreshServices() {
    const services = await api('/api/monitoring/services');
    servicesCache = services || [];
    const tbody = document.getElementById('monitoring-services');
    if (!services || services.length === 0) { tbody.innerHTML = '<tr><td colspan="9" class="empty-state">No services registered yet. Click "+ Add Service" to start monitoring.</td></tr>'; return; }
    tbody.innerHTML = services.map(s => {
        const enabledIcon = s.enabled
            ? '<span style="color:var(--green);font-weight:600">ON</span>'
            : '<span style="color:var(--text-dim);font-weight:600">OFF</span>';
        const rowOpacity = s.enabled ? '1' : '0.5';
        return `<tr style="opacity:${rowOpacity}">
        <td><strong>${s.name}</strong><br><span style="font-size:11px;color:var(--text-dim)">${s.displayName || ''}</span></td>
        <td><span class="tag">${s.type}</span></td>
        <td style="font-size:12px;font-family:var(--mono)">${s.healthEndpoint || '-'}</td>
        <td><span class="badge-status badge-${s.healthStatus?.toLowerCase()}">${s.healthStatus}</span></td>
        <td>${enabledIcon}</td>
        <td>${s.consecutiveFailures || 0}</td>
        <td style="font-size:12px;color:var(--text-dim)">${s.checkIntervalSeconds || 60}s</td>
        <td style="font-size:12px;color:var(--text-dim)">${s.lastCheckAt ? new Date(s.lastCheckAt).toLocaleString() : 'Never'}</td>
        <td>
            <div class="btn-group" style="flex-wrap:nowrap;">
                <button class="btn btn-sm btn-secondary" onclick="checkServiceHealth('${s.name}')" title="Run health check now">Check</button>
                <button class="btn btn-sm btn-secondary" onclick="editService('${s.id}')" title="Edit configuration">Edit</button>
                <button class="btn btn-sm ${s.enabled ? 'btn-danger' : 'btn-primary'}" onclick="toggleService('${s.id}')" title="${s.enabled ? 'Disable monitoring' : 'Enable monitoring'}">${s.enabled ? 'Disable' : 'Enable'}</button>
                <button class="btn btn-sm btn-danger" onclick="deleteService('${s.id}')" title="Remove from monitoring">‚úï</button>
            </div>
        </td>
    </tr>`;
    }).join('');
}
async function addService() {
    const body = {
        name: document.getElementById('svc-name').value,
        displayName: document.getElementById('svc-display').value,
        type: document.getElementById('svc-type').value,
        healthEndpoint: document.getElementById('svc-endpoint').value,
        metricsEndpoint: document.getElementById('svc-metrics').value || null,
        logSource: document.getElementById('svc-logsource').value || null,
        namespace: document.getElementById('svc-namespace').value || null,
        cluster: document.getElementById('svc-cluster').value || null,
        checkIntervalSeconds: parseInt(document.getElementById('svc-interval').value) || 60,
        enabled: true
    };
    await api('/api/monitoring/services', { method: 'POST', body: JSON.stringify(body) });
    closeModal('add-service-modal');
    // Clear form
    ['svc-name','svc-display','svc-endpoint','svc-metrics','svc-logsource','svc-namespace','svc-cluster'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('svc-interval').value = '60';
    document.getElementById('svc-type').selectedIndex = 0;
    refreshServices();
    refreshDashboard();
}
function editService(id) {
    const svc = servicesCache.find(s => s.id === id);
    if (!svc) { alert('Service not found'); return; }
    document.getElementById('edit-svc-id').value = svc.id;
    document.getElementById('edit-svc-name').value = svc.name || '';
    document.getElementById('edit-svc-display').value = svc.displayName || '';
    document.getElementById('edit-svc-type').value = svc.type || 'HTTP';
    document.getElementById('edit-svc-interval').value = svc.checkIntervalSeconds || 60;
    document.getElementById('edit-svc-endpoint').value = svc.healthEndpoint || '';
    document.getElementById('edit-svc-metrics').value = svc.metricsEndpoint || '';
    document.getElementById('edit-svc-logsource').value = svc.logSource || '';
    document.getElementById('edit-svc-namespace').value = svc.namespace || '';
    document.getElementById('edit-svc-cluster').value = svc.cluster || '';
    document.getElementById('edit-svc-enabled').checked = svc.enabled;
    openModal('edit-service-modal');
}
async function updateService() {
    const id = document.getElementById('edit-svc-id').value;
    const body = {
        name: document.getElementById('edit-svc-name').value,
        displayName: document.getElementById('edit-svc-display').value,
        type: document.getElementById('edit-svc-type').value,
        healthEndpoint: document.getElementById('edit-svc-endpoint').value,
        metricsEndpoint: document.getElementById('edit-svc-metrics').value || null,
        logSource: document.getElementById('edit-svc-logsource').value || null,
        namespace: document.getElementById('edit-svc-namespace').value || null,
        cluster: document.getElementById('edit-svc-cluster').value || null,
        checkIntervalSeconds: parseInt(document.getElementById('edit-svc-interval').value) || 60,
        enabled: document.getElementById('edit-svc-enabled').checked
    };
    const res = await api(`/api/monitoring/services/${id}`, { method: 'PUT', body: JSON.stringify(body) });
    if (res) {
        closeModal('edit-service-modal');
        refreshServices();
        refreshDashboard();
    } else {
        alert('Failed to update service. Check the console for errors.');
    }
}
async function toggleService(id) {
    await api(`/api/monitoring/services/${id}/toggle`, { method: 'PATCH' });
    refreshServices();
    refreshDashboard();
}
async function checkServiceHealth(name) {
    const res = await api(`/api/monitoring/services/${name}/check`, { method: 'POST' });
    if (res) {
        const status = res.healthy ? '‚úÖ HEALTHY' : '‚ùå UNHEALTHY';
        alert(`${status}\n${res.message}\nResponse time: ${res.duration_ms}ms`);
        refreshServices();
        refreshDashboard();
    }
}
async function deleteService(id) {
    if (!confirm('Remove this service from monitoring?')) return;
    await api(`/api/monitoring/services/${id}`, { method: 'DELETE' });
    refreshServices();
    refreshDashboard();
}

// ‚îÄ‚îÄ‚îÄ Incidents ‚îÄ‚îÄ‚îÄ
async function refreshIncidents() {
    const incidents = await api('/api/incidents');
    const tbody = document.getElementById('incidents-table');
    if (!incidents || incidents.length === 0) { tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No incidents yet.</td></tr>'; return; }
    tbody.innerHTML = incidents.map(i => {
        const isActive = i.status !== 'RESOLVED' && i.status !== 'CLOSED';
        const escalationDisplay = i.escalationCount > 0
            ? `<span style="color:var(--orange);font-weight:600">Tier ${i.escalationCount}</span>`
            : '<span style="color:var(--text-dim)">-</span>';
        const ackLabel = i.acknowledgedAt ? `<span style="color:var(--green);font-size:11px">ACK'd</span>` : '';
        return `<tr>
        <td><span class="badge-status badge-${i.severity?.toLowerCase()}">${i.severity}</span></td>
        <td><strong>${i.title}</strong><br><span style="font-size:11px;color:var(--text-dim)">${(i.description || '').substring(0, 80)}</span></td>
        <td>${i.service || '-'}</td>
        <td><span class="badge-status badge-${i.status?.toLowerCase()}">${i.status}</span> ${ackLabel}</td>
        <td>${escalationDisplay}</td>
        <td style="font-size:12px;color:var(--text-dim)">${new Date(i.createdAt).toLocaleString()}</td>
        <td>
            <div class="btn-group" style="flex-wrap:nowrap;">
                ${isActive && !i.acknowledgedAt ? `<button class="btn btn-sm btn-secondary" onclick="acknowledgeIncident('${i.id}')">Acknowledge</button>` : ''}
                ${isActive ? `<button class="btn btn-sm btn-secondary" onclick="resolveIncident('${i.id}')">Resolve</button>` : ''}
                ${!isActive ? `<button class="btn btn-sm btn-secondary" onclick="viewIncidentRca('${i.id}')">üìÑ RCA</button>` : ''}
            </div>
        </td>
    </tr>`;
    }).join('');
}
async function createIncident() {
    const body = {
        title: document.getElementById('inc-title').value,
        severity: document.getElementById('inc-severity').value,
        service: document.getElementById('inc-service').value,
        description: document.getElementById('inc-desc').value,
        status: 'OPEN'
    };
    await api('/api/incidents', { method: 'POST', body: JSON.stringify(body) });
    closeModal('create-incident-modal');
    refreshIncidents();
    refreshDashboard();
}
async function resolveIncident(id) {
    const resolution = prompt('Resolution notes:');
    if (resolution === null) return;
    await api(`/api/incidents/${id}/resolve`, { method: 'POST', body: JSON.stringify({ resolution }) });
    refreshIncidents();
    refreshDashboard();
}

// ‚îÄ‚îÄ‚îÄ Alerts ‚îÄ‚îÄ‚îÄ
async function refreshAlerts() {
    const alerts = await api('/api/alerts');
    const tbody = document.getElementById('alerts-table');
    if (!alerts || alerts.length === 0) { tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No alert rules configured. Click "+ Create Alert Rule" to add one.</td></tr>'; return; }
    tbody.innerHTML = alerts.map(a => `<tr>
        <td><strong>${a.name}</strong></td>
        <td style="font-family:var(--mono);font-size:12px">${a.metric}</td>
        <td>${a.condition} ${a.threshold}</td>
        <td><span class="badge-status badge-${a.severity?.toLowerCase()}">${a.severity}</span></td>
        <td>${a.enabled ? '<span style="color:var(--green)">Yes</span>' : '<span style="color:var(--text-dim)">No</span>'}</td>
        <td>${a.triggerCount || 0}</td>
        <td><button class="btn btn-sm btn-danger" onclick="deleteAlert('${a.id}')">Delete</button></td>
    </tr>`).join('');
}
async function createAlert() {
    const body = {
        name: document.getElementById('alert-name').value,
        metric: document.getElementById('alert-metric').value,
        condition: document.getElementById('alert-condition').value,
        threshold: parseFloat(document.getElementById('alert-threshold').value),
        severity: document.getElementById('alert-severity').value,
        serviceName: document.getElementById('alert-service').value,
        durationSeconds: parseInt(document.getElementById('alert-duration').value) || 300,
        enabled: true
    };
    await api('/api/alerts', { method: 'POST', body: JSON.stringify(body) });
    closeModal('create-alert-modal');
    refreshAlerts();
}
async function deleteAlert(id) {
    if (!confirm('Delete this alert rule?')) return;
    await api(`/api/alerts/${id}`, { method: 'DELETE' });
    refreshAlerts();
}

// ‚îÄ‚îÄ‚îÄ Tools ‚îÄ‚îÄ‚îÄ
async function loadTools() {
    const tools = await api('/api/agent/tools/detailed');
    const grid = document.getElementById('tools-grid');
    if (!tools || tools.length === 0) { grid.innerHTML = '<div class="empty-state">No tools available</div>'; return; }
    const catIcon = { monitoring: 'üì°', infrastructure: 'üèóÔ∏è', remediation: 'üîß', diagnostics: 'üîç', incident: 'üö®', alerting: 'üîî' };
    grid.innerHTML = tools.map(t => {
        const icon = catIcon[t.category] || '‚öôÔ∏è';
        const approvalBadge = t.requiresApproval
            ? '<span style="background:var(--yellow-bg);color:var(--yellow);padding:2px 8px;border-radius:4px;font-size:10px;font-weight:600;margin-left:6px;">APPROVAL</span>'
            : '';
        const toggleChecked = t.requiresApproval ? 'checked' : '';
        return `<div class="tool-card">
            <div style="display:flex;align-items:center;justify-content:space-between;">
                <h4>${icon} ${t.name}${approvalBadge}</h4>
            </div>
            <p>${t.description}</p>
            <div style="display:flex;align-items:center;justify-content:space-between;margin-top:8px;">
                <span class="tag">${t.category}</span>
                <label style="display:flex;align-items:center;gap:6px;font-size:11px;color:var(--text-dim);cursor:pointer;" title="Toggle whether this tool requires human approval">
                    <span>Approval required</span>
                    <input type="checkbox" ${toggleChecked} onchange="toggleToolApproval('${t.name}', this.checked)"
                        style="width:16px;height:16px;accent-color:var(--yellow);cursor:pointer;">
                </label>
            </div>
        </div>`;
    }).join('');
}
async function toggleToolApproval(toolName, requiresApproval) {
    const res = await api(`/api/agent/tools/${toolName}/approval`, {
        method: 'PATCH',
        body: JSON.stringify({ requiresApproval })
    });
    if (res) {
        const status = requiresApproval ? 'now requires' : 'no longer requires';
        addEvent('tool.approval_changed', `${toolName} ${status} approval`);
    }
}

// ‚îÄ‚îÄ‚îÄ Playbooks ‚îÄ‚îÄ‚îÄ
async function loadPlaybooks() {
    const data = await api('/api/playbooks/list');
    const tbody = document.getElementById('playbooks-table');
    if (!data || !Array.isArray(data) || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No playbooks available. Create one using the button above or ask the agent in chat.</td></tr>';
        loadSuggestions();
        return;
    }
    tbody.innerHTML = data.map(pb => {
        // Build trigger badges
        let triggerHtml = '';
        if (pb.triggers && pb.triggers.length > 0) {
            const t = pb.triggers[0];
            const svc = t.service || '*';
            const sevs = (t.severities && t.severities.length > 0) ? t.severities : (t.severity ? [t.severity] : ['*']);
            triggerHtml = `<div style="font-size:11px;"><code>${svc}</code></div>`;
            triggerHtml += `<div style="margin-top:2px;">${sevs.map(s => `<span class="badge" style="font-size:10px;padding:1px 5px;margin:1px;${s==='CRITICAL'?'background:var(--error);color:white;':s==='HIGH'?'background:var(--warning);color:#000;':''}">${s}</span>`).join('')}</div>`;
        } else {
            triggerHtml = '<span style="color:var(--text-dim);font-size:11px;">Manual</span>';
        }

        const enabledToggle = pb.enabled
            ? `<span style="color:var(--green);cursor:pointer;" onclick="togglePlaybookEnabled('${pb.id}')" title="Click to disable">‚óè On</span>`
            : `<span style="color:var(--text-dim);cursor:pointer;" onclick="togglePlaybookEnabled('${pb.id}')" title="Click to enable">‚óã Off</span>`;

        const sourceLabel = pb.source || 'ui';
        const sourceBadge = `<span style="font-size:10px;background:var(--bg-surface);padding:1px 5px;border-radius:4px;">${sourceLabel}</span>`;

        return `<tr${!pb.enabled ? ' style="opacity:0.5;"' : ''}>
            <td>
                <strong>${pb.name || pb.id}</strong>
                <div style="font-size:11px;color:var(--text-dim);margin-top:2px;">
                    ${pb.description ? pb.description.substring(0, 80) + (pb.description.length > 80 ? '...' : '') : ''}
                </div>
            </td>
            <td>${triggerHtml}</td>
            <td style="text-align:center;">${pb.steps}</td>
            <td style="text-align:center;">${pb.approvalRequired ? '<span class="badge" style="background:var(--warning);color:#000;">Yes</span>' : 'No'}</td>
            <td style="text-align:center;">${enabledToggle}</td>
            <td style="text-align:center;">${sourceBadge}</td>
            <td>
                <div class="btn-group" style="flex-wrap:nowrap;">
                    <button class="btn btn-sm btn-secondary" onclick="editPlaybook('${pb.id}')" title="Edit">Edit</button>
                    <button class="btn btn-sm btn-secondary" onclick="viewPlaybook('${pb.id}')" title="View details">View</button>
                    <button class="btn btn-sm btn-secondary" onclick="dryRunPlaybook('${pb.id}')" title="Dry run">Dry</button>
                    <button class="btn btn-sm" style="background:var(--error);color:white;" onclick="deletePlaybook('${pb.id}', '${(pb.name||'').replace(/'/g,'&#39;')}')">Del</button>
                </div>
            </td>
        </tr>`;
    }).join('');
    // Also load suggestions
    loadSuggestions();
}

async function viewPlaybook(id) {
    const pb = await api(`/api/playbooks/${id}`);
    if (!pb) { alert('Playbook not found'); return; }
    let details = `Name: ${pb.name}\nID: ${pb.id}\nDescription: ${pb.description || ''}\nApproval: ${pb.approvalRequired}\nSteps:\n`;
    (pb.steps || []).forEach((s, i) => {
        details += `  ${i+1}. ${s.name} (tool: ${s.tool}, onFailure: ${s.onFailure || 'continue'})\n`;
        if (s.parameters && Object.keys(s.parameters).length > 0) {
            details += `     params: ${JSON.stringify(s.parameters)}\n`;
        }
    });
    if (pb.triggers && pb.triggers.length > 0) {
        details += `Triggers:\n`;
        pb.triggers.forEach(t => {
            const sevs = (t.severities && t.severities.length > 0) ? t.severities.join(',') : (t.severity || '*');
            details += `  - ${t.type}: service=${t.service || '*'}, severities=${sevs}\n`;
        });
    }
    alert(details);
}

async function editPlaybook(id) {
    const pb = await api(`/api/playbooks/${id}`);
    if (!pb) { alert('Playbook not found'); return; }

    // Set modal to edit mode
    document.getElementById('pb-modal-title').textContent = 'Edit Playbook';
    document.getElementById('pb-edit-id').value = id;
    document.getElementById('pb-name').value = pb.name || '';
    document.getElementById('pb-description').value = pb.description || '';
    document.getElementById('pb-author').value = pb.author || 'user';
    document.getElementById('pb-tags').value = (pb.tags || []).join(', ');
    document.getElementById('pb-approval').checked = pb.approvalRequired || false;

    // Enabled checkbox ‚Äî need to fetch from the list endpoint since the Playbook POJO doesn't have enabled
    // We'll default to checked; the toggle is on the table row anyway
    document.getElementById('pb-enabled').checked = true;

    // Triggers
    if (pb.triggers && pb.triggers.length > 0) {
        const t = pb.triggers[0];
        document.getElementById('pb-trigger-type').value = t.type || 'service_unhealthy';
        document.getElementById('pb-trigger-service').value = t.service || '';

        // Clear all severity checkboxes, then set
        document.querySelectorAll('.pb-sev-cb').forEach(cb => cb.checked = false);
        const sevs = (t.severities && t.severities.length > 0) ? t.severities : (t.severity ? [t.severity] : []);
        sevs.forEach(s => {
            const cb = document.querySelector(`.pb-sev-cb[value="${s}"]`);
            if (cb) cb.checked = true;
        });
    } else {
        document.getElementById('pb-trigger-type').value = 'service_unhealthy';
        document.getElementById('pb-trigger-service').value = '';
        document.querySelectorAll('.pb-sev-cb').forEach(cb => cb.checked = false);
    }

    // Steps
    const stepsContainer = document.getElementById('pb-steps-list');
    stepsContainer.innerHTML = '';
    pbStepCounter = 0;
    if (pb.steps && pb.steps.length > 0) {
        for (const step of pb.steps) {
            addPlaybookStep();
            const stepEl = stepsContainer.lastElementChild;
            stepEl.querySelector('.pb-step-name').value = step.name || '';
            stepEl.querySelector('.pb-step-tool').value = step.tool || 'health_check';
            stepEl.querySelector('.pb-step-params').value = step.parameters ? JSON.stringify(step.parameters) : '';
            stepEl.querySelector('.pb-step-onfailure').value = step.onFailure || 'continue';
        }
    }

    openModal('create-playbook-modal');
}

async function togglePlaybookEnabled(id) {
    const res = await api(`/api/playbooks/${id}/toggle`, { method: 'PATCH' });
    if (res && res.id) {
        loadPlaybooks();
    } else {
        alert('Failed to toggle playbook: ' + (res ? JSON.stringify(res) : 'Unknown error'));
    }
}

async function deletePlaybook(id, name) {
    if (!confirm(`Are you sure you want to delete playbook "${name || id}"? This cannot be undone.`)) return;
    const res = await api(`/api/playbooks/${id}`, { method: 'DELETE' });
    if (res && res.status === 'deleted') {
        loadPlaybooks();
    } else {
        alert('Failed to delete playbook: ' + (res ? JSON.stringify(res) : 'Unknown error'));
    }
}

async function dryRunPlaybook(id) {
    const params = prompt('Parameters as JSON (or leave empty):', '{}');
    if (params === null) return;
    let parsed = {};
    try { parsed = JSON.parse(params); } catch(e) { alert('Invalid JSON'); return; }
    const res = await api(`/api/playbooks/${id}/execute`, {
        method: 'POST',
        body: JSON.stringify({ dry_run: true, parameters: parsed })
    });
    if (res) alert(res.result || JSON.stringify(res));
}

function openPlaybookModal() {
    resetPlaybookForm();
    document.getElementById('pb-modal-title').textContent = 'Create Playbook';
    openModal('create-playbook-modal');
}

// ‚îÄ‚îÄ‚îÄ Playbook Form (Create/Edit Modal) ‚îÄ‚îÄ‚îÄ
let pbStepCounter = 0;
function addPlaybookStep() {
    const container = document.getElementById('pb-steps-list');
    const idx = pbStepCounter++;
    const div = document.createElement('div');
    div.className = 'card';
    div.id = `pb-step-${idx}`;
    div.style.cssText = 'padding:10px;margin-bottom:8px;';
    div.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
            <strong style="font-size:13px;">Step ${container.children.length + 1}</strong>
            <button class="btn btn-sm" style="background:var(--error);color:white;padding:2px 8px;" onclick="removePlaybookStep('pb-step-${idx}')">‚úï</button>
        </div>
        <div class="form-row">
            <div class="form-group"><label class="form-label">Step Name</label><input class="form-input pb-step-name" placeholder="e.g. Check health"></div>
            <div class="form-group"><label class="form-label">Tool</label>
                <select class="form-select pb-step-tool">
                    <option value="health_check">health_check</option>
                    <option value="docker_exec">docker_exec</option>
                    <option value="kubectl_exec">kubectl_exec</option>
                    <option value="service_restart">service_restart</option>
                    <option value="log_search">log_search</option>
                    <option value="metrics_query">metrics_query</option>
                    <option value="network_diag">network_diag</option>
                    <option value="system_info">system_info</option>
                    <option value="ssh_exec">ssh_exec</option>
                    <option value="incident_manage">incident_manage</option>
                    <option value="alert_manage">alert_manage</option>
                </select>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group" style="flex:2"><label class="form-label">Parameters (JSON)</label><input class="form-input pb-step-params" placeholder='{"url":"http://localhost:8080/health"}'></div>
            <div class="form-group"><label class="form-label">On Failure</label>
                <select class="form-select pb-step-onfailure">
                    <option value="continue">continue</option>
                    <option value="abort">abort</option>
                    <option value="retry">retry</option>
                </select>
            </div>
        </div>`;
    container.appendChild(div);
}

function removePlaybookStep(stepId) {
    const el = document.getElementById(stepId);
    if (el) el.remove();
    // Re-number steps
    const container = document.getElementById('pb-steps-list');
    container.querySelectorAll('.card strong').forEach((el, i) => el.textContent = `Step ${i + 1}`);
}

function resetPlaybookForm() {
    document.getElementById('pb-edit-id').value = '';
    document.getElementById('pb-name').value = '';
    document.getElementById('pb-description').value = '';
    document.getElementById('pb-tags').value = '';
    document.getElementById('pb-author').value = 'user';
    document.getElementById('pb-approval').checked = false;
    document.getElementById('pb-enabled').checked = true;
    document.getElementById('pb-trigger-type').value = 'service_unhealthy';
    document.getElementById('pb-trigger-service').value = '';
    // Reset severity checkboxes to default (HIGH + CRITICAL)
    document.querySelectorAll('.pb-sev-cb').forEach(cb => {
        cb.checked = (cb.value === 'HIGH' || cb.value === 'CRITICAL');
    });
    document.getElementById('pb-steps-list').innerHTML = '';
    pbStepCounter = 0;
}

async function savePlaybook() {
    const editId = document.getElementById('pb-edit-id').value;
    const name = document.getElementById('pb-name').value.trim();
    if (!name) { alert('Playbook name is required'); return; }

    const stepEls = document.getElementById('pb-steps-list').children;
    if (stepEls.length === 0) { alert('At least one step is required'); return; }

    const steps = [];
    for (let i = 0; i < stepEls.length; i++) {
        const el = stepEls[i];
        const stepName = el.querySelector('.pb-step-name').value.trim() || `Step ${i+1}`;
        const tool = el.querySelector('.pb-step-tool').value;
        const paramsStr = el.querySelector('.pb-step-params').value.trim();
        const onFailure = el.querySelector('.pb-step-onfailure').value;
        let params = {};
        if (paramsStr) {
            try { params = JSON.parse(paramsStr); } catch(e) { alert(`Step ${i+1}: Invalid JSON parameters`); return; }
        }
        steps.push({ order: i + 1, name: stepName, tool, parameters: params, onFailure });
    }

    const tagsStr = document.getElementById('pb-tags').value.trim();
    const tags = tagsStr ? tagsStr.split(',').map(t => t.trim()).filter(t => t) : [];
    const approvalRequired = document.getElementById('pb-approval').checked;
    const triggerType = document.getElementById('pb-trigger-type').value;
    const triggerService = document.getElementById('pb-trigger-service').value.trim();
    const description = document.getElementById('pb-description').value.trim();
    const author = document.getElementById('pb-author').value.trim() || 'user';

    // Collect multi-severity checkboxes
    const selectedSeverities = [];
    document.querySelectorAll('.pb-sev-cb:checked').forEach(cb => selectedSeverities.push(cb.value));

    const triggers = [];
    if (triggerType !== 'manual') {
        triggers.push({
            type: triggerType,
            service: triggerService || '*',
            severities: selectedSeverities.length > 0 ? selectedSeverities : ['*']
        });
    }

    const playbook = { name, description, author, steps, tags, approvalRequired, triggers, maxExecutionTimeSeconds: 300 };

    let res;
    if (editId) {
        // Update existing playbook
        res = await api(`/api/playbooks/${editId}`, {
            method: 'PUT',
            body: JSON.stringify(playbook)
        });
    } else {
        // Create new playbook
        res = await api('/api/playbooks', {
            method: 'POST',
            body: JSON.stringify(playbook)
        });
    }

    if (res && (res.id || res.message)) {
        closeModal('create-playbook-modal');
        resetPlaybookForm();
        loadPlaybooks();
    } else {
        alert('Failed to save playbook: ' + (res ? (res.error || JSON.stringify(res)) : 'Unknown error'));
    }
}

// ‚îÄ‚îÄ‚îÄ Playbook Suggestions ‚îÄ‚îÄ‚îÄ
async function generateAiSuggestions() {
    const btn = document.getElementById('btn-generate-ai');
    const origText = btn.textContent;
    btn.disabled = true;
    btn.textContent = '‚è≥ Generating...';
    try {
        const res = await api('/api/playbooks/suggestions/generate-ai', { method: 'POST' });
        if (res && res.status === 'completed') {
            await loadSuggestions();
            btn.textContent = '‚úì Done!';
            setTimeout(() => { btn.textContent = origText; btn.disabled = false; }, 2000);
        } else {
            btn.textContent = '‚úó Failed';
            setTimeout(() => { btn.textContent = origText; btn.disabled = false; }, 3000);
        }
    } catch (e) {
        btn.textContent = '‚úó Error';
        setTimeout(() => { btn.textContent = origText; btn.disabled = false; }, 3000);
    }
}

async function loadSuggestions() {
    try {
        const data = await api('/api/playbooks/suggestions');
        const section = document.getElementById('suggestions-section');
        const container = document.getElementById('suggestions-list');
        const badge = document.getElementById('suggestion-badge');
        const inlineBadge = document.getElementById('inline-suggestion-badge');

        if (!data || !Array.isArray(data) || data.length === 0) {
            section.style.display = 'none';
            badge.style.display = 'none';
            return;
        }

        section.style.display = 'block';
        badge.style.display = 'inline-block';
        badge.textContent = data.length;
        inlineBadge.textContent = data.length;

        container.innerHTML = data.map(s => `
            <div class="card" style="border-left:3px solid var(--primary);margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;">
                <div style="flex:1;">
                    <strong>${s.name}</strong>
                    <span class="badge" style="margin-left:8px;">Seen ${s.frequency}x</span>
                    <div style="font-size:12px;color:var(--text-dim);margin-top:4px;">
                        Service: <code>${s.service}</code> &nbsp;|&nbsp; Avg resolution: ${Math.round(s.avgResolutionMs/1000)}s
                    </div>
                    <div style="font-size:12px;color:var(--text-dim);margin-top:2px;">
                        <em>${(s.description || '').substring(0, 150)}</em>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-sm btn-primary" onclick="approveSuggestion('${s.id}')">Approve</button>
                    <button class="btn btn-sm btn-secondary" onclick="dismissSuggestion('${s.id}')">Dismiss</button>
                </div>
            </div>`).join('');
    } catch(e) {
        // Suggestions not available - that's fine
    }
}

async function approveSuggestion(id) {
    const res = await api(`/api/playbooks/suggestions/${id}/approve`, {
        method: 'POST',
        body: JSON.stringify({ reviewed_by: 'user' })
    });
    if (res && res.status === 'APPROVED') {
        loadPlaybooks(); // also refreshes suggestions
    } else {
        alert('Failed to approve suggestion: ' + (res ? (res.error || JSON.stringify(res)) : 'Unknown error'));
    }
}

async function dismissSuggestion(id) {
    if (!confirm('Dismiss this suggestion? It will not be shown again for this pattern.')) return;
    const res = await api(`/api/playbooks/suggestions/${id}/dismiss`, {
        method: 'POST',
        body: JSON.stringify({ reviewed_by: 'user' })
    });
    if (res && res.status === 'DISMISSED') {
        loadPlaybooks();
    }
}

// ‚îÄ‚îÄ‚îÄ Agent Chat ‚îÄ‚îÄ‚îÄ
let chatSessionId = null;

async function sendChat() {
    const input = document.getElementById('chat-input');
    const msg = input.value.trim();
    if (!msg) return;
    input.value = '';
    appendChat('user', msg);
    const thinkingDiv = document.createElement('div');
    thinkingDiv.className = 'chat-msg assistant';
    thinkingDiv.id = 'chat-thinking';
    thinkingDiv.innerHTML = '<div class="loading"></div> Thinking...';
    document.getElementById('chat-messages').appendChild(thinkingDiv);
    document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
    const body = { message: msg };
    if (chatSessionId) body.session_id = chatSessionId;
    const res = await api('/api/agent/chat', {
        method: 'POST',
        body: JSON.stringify(body)
    });
    // Remove loading message by ID (reliable even if WebSocket messages were appended in between)
    const thinkingEl = document.getElementById('chat-thinking');
    if (thinkingEl) thinkingEl.remove();
    if (res && res.response) {
        // Persist session for multi-turn conversation
        if (res.session_id) chatSessionId = res.session_id;

        let text = res.response;
        if (res.tools_used && res.tools_used.length > 0) text += `\n\nüîß Tools used: ${res.tools_used.join(', ')}`;
        appendChat('assistant', formatResponse(text));

        // If 3+ tools were used, offer to save as playbook
        if (res.tools_used && res.tools_used.length >= 3 && res.session_id) {
            const saveBtn = document.createElement('div');
            saveBtn.className = 'chat-msg system';
            saveBtn.innerHTML = `<strong>Auto-playbook suggestion:</strong> This resolution used ${res.tools_used.length} tools. ` +
                `<button class="btn btn-sm btn-primary" style="margin-left:8px;" ` +
                `onclick="saveAsPlaybook('${res.session_id}')">Save as Playbook</button>`;
            document.getElementById('chat-messages').appendChild(saveBtn);
        }
    } else {
        appendChat('assistant', 'Error: Could not get a response. Make sure OPENAI_API_KEY is set.');
    }
}

function newChatSession() {
    chatSessionId = null;
    const msgs = document.getElementById('chat-messages');
    msgs.innerHTML = '<div class="chat-msg system">New conversation started. Ask me anything about your services, incidents, or infrastructure.</div>';
}
function appendChat(role, html) {
    const msgs = document.getElementById('chat-messages');
    const div = document.createElement('div');
    div.className = `chat-msg ${role}`;
    div.innerHTML = html;
    msgs.appendChild(div);
    msgs.scrollTop = msgs.scrollHeight;
}
function formatResponse(text) {
    // Basic markdown-like formatting
    return text
        .replace(/```([\s\S]*?)```/g, '<pre>$1</pre>')
        .replace(/`([^`]+)`/g, '<code style="background:var(--bg);padding:2px 5px;border-radius:3px;font-size:12px">$1</code>')
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n/g, '<br>');
}

// ‚îÄ‚îÄ‚îÄ Save as Playbook (from chat) ‚îÄ‚îÄ‚îÄ
async function saveAsPlaybook(sessionId) {
    const name = prompt('Playbook name:', 'auto-remediation-playbook');
    if (!name) return;
    const description = prompt('Description (optional):', '');
    const res = await api('/api/playbooks/generate', {
        method: 'POST',
        body: JSON.stringify({ sessionId, name, description: description || null })
    });
    if (res && res.id) {
        appendChat('system', `Playbook "${res.name}" saved with ${res.steps} steps! Find it in the Playbooks page.`);
        loadPlaybooks();
    } else {
        appendChat('system', `Failed to save playbook: ${res?.error || 'unknown error'}`);
    }
}

// ‚îÄ‚îÄ‚îÄ Acknowledge Incident ‚îÄ‚îÄ‚îÄ
async function acknowledgeIncident(id) {
    await api(`/api/incidents/${id}/acknowledge`, { method: 'POST', body: '{}' });
    refreshIncidents();
    refreshDashboard();
}

// ‚îÄ‚îÄ‚îÄ Approvals ‚îÄ‚îÄ‚îÄ
async function refreshApprovals() {
    const approvals = await api('/api/approvals/pending');
    const badge = document.getElementById('approval-badge');
    if (approvals && approvals.length > 0) {
        badge.textContent = approvals.length;
        badge.style.display = '';
    } else {
        badge.style.display = 'none';
    }
    const tbody = document.getElementById('approvals-table');
    if (!approvals || approvals.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No pending approvals</td></tr>';
        return;
    }
    tbody.innerHTML = approvals.map(a => {
        let paramsDisplay = '-';
        try { paramsDisplay = JSON.stringify(JSON.parse(a.parameters), null, 0).substring(0, 120); } catch(e) {}
        return `<tr>
            <td><strong>${a.toolName}</strong></td>
            <td style="font-family:var(--mono);font-size:11px">${paramsDisplay}</td>
            <td style="font-size:11px;color:var(--text-dim)">${a.sessionId || '-'}</td>
            <td style="font-size:12px;color:var(--text-dim)">${new Date(a.requestedAt).toLocaleString()}</td>
            <td><span class="badge-status badge-${a.status === 'PENDING' ? 'medium' : a.status === 'APPROVED' ? 'healthy' : 'unhealthy'}">${a.status}</span></td>
            <td>
                <div class="btn-group" style="flex-wrap:nowrap;">
                    <button class="btn btn-sm btn-primary" onclick="respondApproval('${a.id}', true)">Approve</button>
                    <button class="btn btn-sm btn-danger" onclick="respondApproval('${a.id}', false)">Deny</button>
                </div>
            </td>
        </tr>`;
    }).join('');
}
async function respondApproval(id, approved) {
    await api(`/api/approvals/${id}/respond`, {
        method: 'POST',
        body: JSON.stringify({ approved: approved, respondedBy: 'ui-user' })
    });
    refreshApprovals();
}

// ‚îÄ‚îÄ‚îÄ Audit Log ‚îÄ‚îÄ‚îÄ
async function refreshAuditLog() {
    const actor = document.getElementById('audit-actor-filter').value;
    const action = document.getElementById('audit-action-filter').value;
    let url = '/api/audit?limit=100';
    if (actor) url += `&actor=${actor}`;
    if (action) url += `&action=${action}`;
    const logs = await api(url);
    const tbody = document.getElementById('audit-table');
    if (!logs || logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No audit entries yet. Actions will appear here as the agent works.</td></tr>';
        return;
    }
    tbody.innerHTML = logs.map(l => {
        let details = '-';
        try { if (l.details) details = JSON.stringify(JSON.parse(l.details), null, 0).substring(0, 150); } catch(e) { details = l.details?.substring(0, 150) || '-'; }
        return `<tr>
            <td style="font-size:11px;color:var(--text-dim);white-space:nowrap">${new Date(l.timestamp).toLocaleString()}</td>
            <td><span class="tag">${l.actor}</span></td>
            <td><strong style="font-size:12px">${l.action}</strong></td>
            <td style="font-size:12px;font-family:var(--mono)">${l.target || '-'}</td>
            <td>${l.success ? '<span style="color:var(--green)">OK</span>' : '<span style="color:var(--red)">FAIL</span>'}</td>
            <td style="font-size:11px;color:var(--text-dim);max-width:300px;overflow:hidden;text-overflow:ellipsis">${details}</td>
        </tr>`;
    }).join('');
}

// ‚îÄ‚îÄ‚îÄ Insights ‚îÄ‚îÄ‚îÄ
async function refreshInsights() {
    const data = await api('/api/learning/insights');
    const container = document.getElementById('insights-container');
    if (!data || data.total_resolutions === 0) {
        container.innerHTML = '<div style="color:var(--text-dim);padding:8px 0;">No resolution data yet. As the agent resolves incidents, patterns and success rates will appear here.</div>';
        return;
    }
    let html = `<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px;">
        <div style="background:var(--bg-input);padding:14px;border-radius:var(--radius-sm);">
            <div style="font-size:24px;font-weight:700;color:var(--text)">${data.total_resolutions}</div>
            <div style="font-size:11px;color:var(--text-dim)">Total Resolutions</div>
        </div>
        <div style="background:var(--bg-input);padding:14px;border-radius:var(--radius-sm);">
            <div style="font-size:24px;font-weight:700;color:var(--green)">${data.total_successful || 0}</div>
            <div style="font-size:11px;color:var(--text-dim)">Successful</div>
        </div>
        <div style="background:var(--bg-input);padding:14px;border-radius:var(--radius-sm);">
            <div style="font-size:24px;font-weight:700;color:var(--accent)">${(data.overall_success_rate || 0).toFixed(1)}%</div>
            <div style="font-size:11px;color:var(--text-dim)">Success Rate</div>
        </div>
    </div>`;

    if (data.service_stats && data.service_stats.length > 0) {
        html += '<div style="margin-bottom:12px;"><strong style="font-size:12px;color:var(--text);">Per-Service Stats</strong></div>';
        html += '<table style="font-size:12px;"><thead><tr><th>Service</th><th>Total</th><th>Successful</th><th>Rate</th><th>Avg Time</th></tr></thead><tbody>';
        data.service_stats.forEach(s => {
            html += `<tr>
                <td><strong>${s.service}</strong></td>
                <td>${s.total}</td>
                <td>${s.successful}</td>
                <td style="color:var(--green)">${(s.success_rate || 0).toFixed(1)}%</td>
                <td style="color:var(--text-dim)">${s.avg_resolution_ms > 0 ? (s.avg_resolution_ms / 1000).toFixed(1) + 's' : '-'}</td>
            </tr>`;
        });
        html += '</tbody></table>';
    }

    if (data.patterns && data.patterns.length > 0) {
        html += '<div style="margin-top:16px;margin-bottom:8px;"><strong style="font-size:12px;color:var(--text);">Top Resolution Patterns</strong></div>';
        data.patterns.forEach(p => {
            try {
                const tools = JSON.parse(p.sequence);
                html += `<div style="padding:6px 0;border-bottom:1px solid var(--border);">
                    <span style="color:var(--accent)">${tools.join(' ‚Üí ')}</span>
                    <span style="color:var(--text-dim);margin-left:8px;">(${p.count}x)</span>
                </div>`;
            } catch(e) {}
        });
    }
    container.innerHTML = html;
}

// ‚îÄ‚îÄ‚îÄ Learnings Page ‚îÄ‚îÄ‚îÄ
let allLearningRecords = [];

async function loadLearnings() {
    // Load summary
    const insights = await api('/api/learning/insights');
    if (insights) {
        document.getElementById('lr-total').textContent = insights.total_resolutions || 0;
        document.getElementById('lr-successful').textContent = insights.total_successful || 0;
        document.getElementById('lr-rate').textContent = (insights.overall_success_rate || 0).toFixed(1) + '%';
        // Calculate avg resolution time from service stats
        if (insights.service_stats && insights.service_stats.length > 0) {
            const totalMs = insights.service_stats.reduce((sum, s) => sum + (s.avg_resolution_ms || 0), 0);
            const avg = totalMs / insights.service_stats.length;
            document.getElementById('lr-avg-time').textContent = avg > 0 ? (avg / 1000).toFixed(1) + 's' : '-';
        } else {
            document.getElementById('lr-avg-time').textContent = '-';
        }
    }

    // Load records
    const serviceFilter = document.getElementById('lr-filter-service').value;
    const url = serviceFilter ? `/api/learning/records?service=${encodeURIComponent(serviceFilter)}` : '/api/learning/records';
    const records = await api(url);
    if (!records || !Array.isArray(records)) {
        document.getElementById('learnings-tbody').innerHTML =
            '<tr><td colspan="7" style="text-align:center;padding:24px;color:var(--text-dim);">No learning records found.</td></tr>';
        allLearningRecords = [];
        return;
    }
    allLearningRecords = records;

    // Populate service filter dropdown (preserve current selection)
    const currentFilter = document.getElementById('lr-filter-service').value;
    const services = [...new Set(records.map(r => r.service).filter(Boolean))].sort();
    const filterEl = document.getElementById('lr-filter-service');
    const existingOptions = [...filterEl.options].map(o => o.value);
    services.forEach(s => {
        if (!existingOptions.includes(s)) {
            const opt = document.createElement('option');
            opt.value = s; opt.textContent = s;
            filterEl.appendChild(opt);
        }
    });
    filterEl.value = currentFilter;

    filterLearningsTable();
}

function filterLearningsTable() {
    const successFilter = document.getElementById('lr-filter-success').value;
    let filtered = allLearningRecords;
    if (successFilter === 'true') filtered = filtered.filter(r => r.success);
    if (successFilter === 'false') filtered = filtered.filter(r => !r.success);
    renderLearningsTable(filtered);
}

function renderLearningsTable(records) {
    const tbody = document.getElementById('learnings-tbody');
    if (records.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:24px;color:var(--text-dim);">No records match the current filters.</td></tr>';
        return;
    }
    tbody.innerHTML = records.map(r => {
        let tools = '';
        try {
            const arr = JSON.parse(r.toolSequence || '[]');
            tools = arr.map(t => `<code style="font-size:11px;">${t}</code>`).join(' <span style="color:var(--text-dim);">&rarr;</span> ');
        } catch(e) { tools = r.toolSequence || ''; }
        const date = r.createdAt ? r.createdAt.substring(0, 19).replace('T', ' ') : '-';
        const successBadge = r.success
            ? '<span class="badge" style="background:var(--green);color:#000;">SUCCESS</span>'
            : '<span class="badge" style="background:var(--error);color:#fff;">FAILED</span>';
        const timeSec = r.resolutionTimeMs > 0 ? (r.resolutionTimeMs / 1000).toFixed(1) + 's' : '-';
        return `<tr>
            <td style="white-space:nowrap;font-size:12px;">${date}</td>
            <td><strong>${r.service || '-'}</strong></td>
            <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${(r.incidentTitle||'').replace(/"/g,'&quot;')}">${r.incidentTitle || '-'}</td>
            <td style="max-width:300px;overflow:hidden;">${tools}</td>
            <td>${successBadge}</td>
            <td style="white-space:nowrap;">${timeSec}</td>
            <td style="white-space:nowrap;">
                <button class="btn btn-sm btn-secondary" onclick="openLearningModal('${r.id}')">Edit</button>
                <button class="btn btn-sm" style="background:var(--error);color:white;" onclick="deleteLearning('${r.id}')">Delete</button>
            </td>
        </tr>`;
    }).join('');
}

async function openLearningModal(id) {
    document.getElementById('lr-edit-id').value = '';
    document.getElementById('lr-service').value = '';
    document.getElementById('lr-incident-id').value = '';
    document.getElementById('lr-title').value = '';
    document.getElementById('lr-tools').value = '';
    document.getElementById('lr-time').value = '0';
    document.getElementById('lr-success').checked = true;
    document.getElementById('learning-modal-title').textContent = 'Add Learning Record';

    if (id) {
        const record = await api(`/api/learning/records/${id}`);
        if (record) {
            document.getElementById('lr-edit-id').value = record.id;
            document.getElementById('lr-service').value = record.service || '';
            document.getElementById('lr-incident-id').value = record.incidentId || '';
            document.getElementById('lr-title').value = record.incidentTitle || '';
            document.getElementById('lr-success').checked = record.success;
            document.getElementById('lr-time').value = record.resolutionTimeMs ? Math.round(record.resolutionTimeMs / 1000) : 0;
            try {
                const tools = JSON.parse(record.toolSequence || '[]');
                document.getElementById('lr-tools').value = tools.join(', ');
            } catch(e) {
                document.getElementById('lr-tools').value = record.toolSequence || '';
            }
            document.getElementById('learning-modal-title').textContent = 'Edit Learning Record';
        }
    }
    openModal('learning-modal');
}

async function saveLearning() {
    const editId = document.getElementById('lr-edit-id').value;
    const service = document.getElementById('lr-service').value.trim();
    const incidentId = document.getElementById('lr-incident-id').value.trim();
    const incidentTitle = document.getElementById('lr-title').value.trim();
    const toolsStr = document.getElementById('lr-tools').value.trim();
    const timeSec = parseInt(document.getElementById('lr-time').value) || 0;
    const success = document.getElementById('lr-success').checked;

    if (!service) { alert('Service name is required'); return; }
    if (!toolsStr) { alert('Tool sequence is required'); return; }

    const toolSequence = toolsStr.split(',').map(t => t.trim()).filter(t => t);

    const body = {
        service,
        incidentId: incidentId || null,
        incidentTitle: incidentTitle || null,
        toolSequence,
        success,
        resolutionTimeMs: timeSec * 1000
    };

    let res;
    if (editId) {
        res = await api(`/api/learning/records/${editId}`, { method: 'PUT', body: JSON.stringify(body) });
    } else {
        res = await api('/api/learning/records', { method: 'POST', body: JSON.stringify(body) });
    }

    if (res && res.id) {
        closeModal('learning-modal');
        loadLearnings();
        refreshInsights(); // Update dashboard card too
    } else {
        alert('Failed to save learning record: ' + (res ? JSON.stringify(res) : 'Unknown error'));
    }
}

async function deleteLearning(id) {
    if (!confirm('Are you sure you want to delete this learning record? This cannot be undone.')) return;
    const res = await api(`/api/learning/records/${id}`, { method: 'DELETE' });
    if (res && res.status === 'deleted') {
        loadLearnings();
        refreshInsights();
    } else {
        alert('Failed to delete record.');
    }
}

// ‚îÄ‚îÄ‚îÄ RPC Commands ‚îÄ‚îÄ‚îÄ
async function sendRpc() {
    const method = document.getElementById('rpc-method').value;
    const resultEl = document.getElementById('rpc-result');
    resultEl.textContent = 'Sending...';
    if (ws && ws.readyState === WebSocket.OPEN) {
        const res = await sendWsRpc(method, {});
        resultEl.textContent = JSON.stringify(res, null, 2);
    } else {
        resultEl.textContent = 'WebSocket not connected. Connect first.';
    }
}

// ‚îÄ‚îÄ‚îÄ Security Audit ‚îÄ‚îÄ‚îÄ
async function runSecurityAudit() {
    const data = await api('/api/security/audit');
    const container = document.getElementById('security-findings');
    if (!data || !data.findings || data.findings.length === 0) {
        container.innerHTML = '<div class="card"><div class="empty-state">No security findings. Your configuration looks good!</div></div>';
        return;
    }
    container.innerHTML = data.findings.map(f => {
        const color = f.severity === 'CRITICAL' ? 'red' : f.severity === 'WARN' ? 'yellow' : 'blue';
        return `<div class="card" style="border-left:3px solid var(--${color});">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                <span class="badge-status badge-${f.severity?.toLowerCase() === 'warn' ? 'medium' : f.severity?.toLowerCase()}">${f.severity}</span>
                <strong>${f.category}</strong>
            </div>
            <p style="font-size:13px;">${f.message}</p>
            <p style="font-size:12px;color:var(--text-dim);margin-top:6px;">üí° ${f.remediation}</p>
        </div>`;
    }).join('');
}

// ‚îÄ‚îÄ‚îÄ RCA Reports ‚îÄ‚îÄ‚îÄ
async function loadRcaReports() {
    const statusFilter = document.getElementById('rca-filter-status')?.value || '';
    const url = statusFilter ? `/api/rca?status=${statusFilter}` : '/api/rca';
    const rcas = await api(url);
    const tbody = document.getElementById('rca-table');

    if (!rcas || rcas.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No RCA reports yet. They are auto-generated when incidents are resolved.</td></tr>';
        updateRcaStats([]);
        return;
    }

    updateRcaStats(rcas);

    tbody.innerHTML = rcas.map(r => {
        const statusColor = r.status === 'APPROVED' ? 'green' : r.status === 'PENDING_REVIEW' ? 'yellow' : r.status === 'REJECTED' ? 'red' : 'blue';
        const statusLabel = r.status === 'PENDING_REVIEW' ? 'Pending Review' : r.status;
        const resTime = formatResTime(r.resolutionTimeMs);
        return `<tr>
            <td>${r.service || '-'}</td>
            <td><strong>${r.incidentTitle || '-'}</strong></td>
            <td><span class="badge-status badge-${(r.severity || 'info').toLowerCase()}">${r.severity || '-'}</span></td>
            <td><span class="badge-status badge-${statusColor}">${statusLabel}</span></td>
            <td style="font-size:12px;">${resTime}</td>
            <td style="font-size:12px;color:var(--text-dim)">${r.generatedAt ? new Date(r.generatedAt).toLocaleString() : '-'}</td>
            <td>
                <div class="btn-group" style="flex-wrap:nowrap;">
                    <button class="btn btn-sm btn-secondary" onclick="openRcaModal('${r.id}')">View</button>
                    ${r.status === 'PENDING_REVIEW' ? `<button class="btn btn-sm btn-primary" onclick="quickApproveRca('${r.id}')">Approve</button>` : ''}
                </div>
            </td>
        </tr>`;
    }).join('');
}

function updateRcaStats(rcas) {
    document.getElementById('rca-stat-total').textContent = rcas.length;
    document.getElementById('rca-stat-pending').textContent = rcas.filter(r => r.status === 'PENDING_REVIEW').length;
    document.getElementById('rca-stat-approved').textContent = rcas.filter(r => r.status === 'APPROVED').length;
    document.getElementById('rca-stat-rejected').textContent = rcas.filter(r => r.status === 'REJECTED').length;
}

function formatResTime(ms) {
    if (!ms || ms <= 0) return '-';
    const s = Math.floor(ms / 1000);
    if (s < 60) return s + 's';
    const m = Math.floor(s / 60);
    if (m < 60) return m + 'm ' + (s % 60) + 's';
    const h = Math.floor(m / 60);
    return h + 'h ' + (m % 60) + 'm';
}

async function refreshRcaBadge() {
    try {
        const data = await api('/api/rca/pending/count');
        const badge = document.getElementById('rca-badge');
        if (data && data.count > 0) {
            badge.textContent = data.count;
            badge.style.display = 'inline-block';
        } else {
            badge.style.display = 'none';
        }
    } catch (e) { /* ignore */ }
}

async function openRcaModal(rcaId) {
    const rca = await api(`/api/rca/${rcaId}`);
    if (!rca) { alert('RCA not found.'); return; }

    document.getElementById('rca-edit-id').value = rca.id;
    document.getElementById('rca-modal-title').textContent = 'RCA Report ‚Äî ' + (rca.incidentTitle || 'Unknown Incident');

    // Header
    document.getElementById('rca-hdr-incident').textContent = rca.incidentTitle || rca.incidentId || '-';
    document.getElementById('rca-hdr-service').textContent = rca.service || '-';
    document.getElementById('rca-hdr-severity').textContent = rca.severity || '-';
    document.getElementById('rca-hdr-time').textContent = formatResTime(rca.resolutionTimeMs);
    try {
        const tools = JSON.parse(rca.toolsUsed || '[]');
        document.getElementById('rca-hdr-tools').textContent = tools.join(', ') || '-';
    } catch(e) {
        document.getElementById('rca-hdr-tools').textContent = rca.toolsUsed || '-';
    }

    // Editable fields
    document.getElementById('rca-summary').value = rca.summary || '';
    document.getElementById('rca-timeline').value = rca.timeline || '';
    document.getElementById('rca-rootcause').value = rca.rootCause || '';
    document.getElementById('rca-impact').value = rca.impact || '';
    document.getElementById('rca-resolution').value = rca.resolution || '';
    document.getElementById('rca-lessons').value = rca.lessonsLearned || '';
    document.getElementById('rca-preventive').value = rca.preventiveMeasures || '';
    document.getElementById('rca-review-notes').value = rca.reviewNotes || '';

    // Show/hide buttons based on status
    const isPending = rca.status === 'PENDING_REVIEW';
    const isApproved = rca.status === 'APPROVED';
    document.getElementById('rca-btn-approve').style.display = isPending ? '' : 'none';
    document.getElementById('rca-btn-reject').style.display = isPending ? '' : 'none';
    document.getElementById('rca-btn-regenerate').style.display = (isPending || rca.status === 'REJECTED') ? '' : 'none';
    document.getElementById('rca-btn-save').style.display = (isPending || isApproved) ? '' : 'none';

    // Status display
    const statusText = rca.status === 'PENDING_REVIEW' ? '‚è≥ Pending Review' :
                       rca.status === 'APPROVED' ? '‚úÖ Approved' + (rca.reviewedBy ? ' by ' + rca.reviewedBy : '') :
                       rca.status === 'REJECTED' ? '‚ùå Rejected' + (rca.reviewedBy ? ' by ' + rca.reviewedBy : '') :
                       '‚è≥ ' + rca.status;
    document.getElementById('rca-modal-status').textContent = statusText +
        (rca.reviewedAt ? ' on ' + new Date(rca.reviewedAt).toLocaleString() : '');

    // Enable/disable editing for approved RCAs
    const editable = isPending || isApproved;
    document.querySelectorAll('#rca-review-modal textarea').forEach(ta => ta.readOnly = !editable);

    openModal('rca-review-modal');
}

function getRcaFormData() {
    return {
        summary: document.getElementById('rca-summary').value,
        timeline: document.getElementById('rca-timeline').value,
        rootCause: document.getElementById('rca-rootcause').value,
        impact: document.getElementById('rca-impact').value,
        resolution: document.getElementById('rca-resolution').value,
        lessonsLearned: document.getElementById('rca-lessons').value,
        preventiveMeasures: document.getElementById('rca-preventive').value,
        reviewNotes: document.getElementById('rca-review-notes').value
    };
}

async function approveRca() {
    const id = document.getElementById('rca-edit-id').value;
    if (!id) return;
    const data = getRcaFormData();
    data.reviewed_by = 'ui-user';
    const res = await api(`/api/rca/${id}/approve`, {
        method: 'POST',
        body: JSON.stringify(data)
    });
    if (res && !res.error) {
        closeModal('rca-review-modal');
        loadRcaReports();
        refreshRcaBadge();
    } else {
        alert('Failed to approve: ' + (res?.error || 'unknown error'));
    }
}

async function quickApproveRca(id) {
    const res = await api(`/api/rca/${id}/approve`, {
        method: 'POST',
        body: JSON.stringify({ reviewed_by: 'ui-user' })
    });
    if (res && !res.error) {
        loadRcaReports();
        refreshRcaBadge();
    }
}

async function rejectRca() {
    const id = document.getElementById('rca-edit-id').value;
    if (!id) return;
    const reason = prompt('Reason for rejection (optional):') || '';
    const regen = confirm('Would you like to regenerate the RCA?');
    const res = await api(`/api/rca/${id}/reject`, {
        method: 'POST',
        body: JSON.stringify({ reviewed_by: 'ui-user', reason: reason, regenerate: regen ? 'true' : 'false' })
    });
    if (res && !res.error) {
        closeModal('rca-review-modal');
        loadRcaReports();
        refreshRcaBadge();
    } else {
        alert('Failed to reject: ' + (res?.error || 'unknown error'));
    }
}

async function regenerateRca() {
    const id = document.getElementById('rca-edit-id').value;
    if (!id) return;
    // First get the incident ID
    const rca = await api(`/api/rca/${id}`);
    if (!rca) return;
    const res = await api(`/api/rca/generate/${rca.incidentId}`, { method: 'POST' });
    if (res && !res.error) {
        closeModal('rca-review-modal');
        appendChat('system', 'üìÑ RCA regeneration started. You will be notified when it is ready.');
    } else {
        alert('Failed to regenerate: ' + (res?.error || 'unknown error'));
    }
}

async function saveRcaEdits() {
    const id = document.getElementById('rca-edit-id').value;
    if (!id) return;
    const data = getRcaFormData();
    const res = await api(`/api/rca/${id}`, {
        method: 'PUT',
        body: JSON.stringify(data)
    });
    if (res && !res.error) {
        alert('RCA edits saved.');
        loadRcaReports();
    } else {
        alert('Failed to save: ' + (res?.error || 'unknown error'));
    }
}

async function viewIncidentRca(incidentId) {
    const rca = await api(`/api/rca/incident/${incidentId}`);
    if (rca && rca.id) {
        document.querySelector('[data-page=rca]').click();
        openRcaModal(rca.id);
    } else {
        // No RCA yet ‚Äî offer to generate
        if (confirm('No RCA exists for this incident yet. Generate one now?')) {
            const res = await api(`/api/rca/generate/${incidentId}`, { method: 'POST' });
            if (res && !res.error) {
                alert('RCA generation started. You will be notified when it is ready.');
            } else {
                alert('Failed to generate: ' + (res?.error || 'unknown error'));
            }
        }
    }
}

// ‚îÄ‚îÄ‚îÄ Risk Assessment ‚îÄ‚îÄ‚îÄ
async function loadRisks() {
    const filter = document.getElementById('risk-filter-status')?.value || '';
    const url = filter ? `/api/risks?status=${filter}` : '/api/risks';
    const risks = await api(url);
    const tbody = document.getElementById('risk-table');
    if (!risks || !risks.length) { tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No risks found ‚Äî system looks healthy!</td></tr>'; updateRiskStats([]); return; }
    updateRiskStats(risks);
    tbody.innerHTML = risks.map(r => {
        const sevClass = r.severity === 'CRITICAL' ? 'red' : r.severity === 'HIGH' ? 'orange' : r.severity === 'MEDIUM' ? 'yellow' : 'blue';
        const statusClass = r.status === 'OPEN' ? 'yellow' : r.status === 'ACKNOWLEDGED' ? 'blue' : 'green';
        const time = r.createdAt ? new Date(r.createdAt).toLocaleString() : '-';
        let actions = '';
        if (r.status === 'OPEN') {
            actions = `<button class="btn btn-secondary" style="padding:3px 8px;font-size:11px;" onclick="acknowledgeRisk('${r.id}')">Acknowledge</button>
                       <button class="btn btn-primary" style="padding:3px 8px;font-size:11px;" onclick="mitigateRisk('${r.id}')">Mitigate</button>`;
        } else if (r.status === 'ACKNOWLEDGED') {
            actions = `<button class="btn btn-primary" style="padding:3px 8px;font-size:11px;" onclick="mitigateRisk('${r.id}')">Mitigate</button>`;
        } else {
            actions = '<span style="color:var(--green);">Mitigated</span>';
        }
        return `<tr>
            <td><span class="severity-badge ${sevClass}">${r.severity}</span></td>
            <td><strong>${r.riskTitle || ''}</strong><br><span style="font-size:11px;color:var(--text-dim);">${(r.description || '').substring(0, 100)}</span></td>
            <td>${r.service || '<em>system-wide</em>'}</td>
            <td><span style="font-size:11px;padding:2px 6px;border-radius:4px;background:var(--${statusClass}-bg);color:var(--${statusClass});">${r.category || '-'}</span></td>
            <td><span style="font-size:11px;padding:2px 6px;border-radius:4px;background:var(--${statusClass}-bg);color:var(--${statusClass});">${r.status}</span></td>
            <td style="font-size:11px;">${time}</td>
            <td>${actions}</td>
        </tr>`;
    }).join('');
}

function updateRiskStats(risks) {
    const open = risks.filter(r => r.status === 'OPEN').length;
    const ack = risks.filter(r => r.status === 'ACKNOWLEDGED').length;
    const mit = risks.filter(r => r.status === 'MITIGATED').length;
    const critHigh = risks.filter(r => r.severity === 'CRITICAL' || r.severity === 'HIGH').length;
    document.getElementById('risk-stat-open').textContent = open;
    document.getElementById('risk-stat-acknowledged').textContent = ack;
    document.getElementById('risk-stat-mitigated').textContent = mit;
    document.getElementById('risk-stat-critical').textContent = critHigh;
}

async function refreshRiskBadge() {
    try {
        const counts = await api('/api/risks/counts');
        const badge = document.getElementById('risk-badge');
        const openCount = counts?.open || 0;
        if (openCount > 0) { badge.style.display = ''; badge.textContent = openCount; }
        else { badge.style.display = 'none'; }
    } catch (e) { /* ignore */ }
}

async function acknowledgeRisk(id) {
    await api(`/api/risks/${id}/acknowledge`, { method: 'POST', body: JSON.stringify({ user: 'operator' }) });
    loadRisks();
    refreshRiskBadge();
}

async function mitigateRisk(id) {
    await api(`/api/risks/${id}/mitigate`, { method: 'POST', body: JSON.stringify({ user: 'operator' }) });
    loadRisks();
    refreshRiskBadge();
    loadDashboardRisks();
}

async function triggerRiskAnalysis() {
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = 'Analyzing...';
    try {
        const res = await api('/api/risks/analyze', { method: 'POST' });
        if (res && res.new_risks !== undefined) {
            alert(`Analysis complete. ${res.new_risks} new risk(s) identified.`);
        }
        loadRisks();
        refreshRiskBadge();
        loadDashboardRisks();
    } catch (e) {
        alert('Analysis failed: ' + e.message);
    } finally {
        btn.disabled = false;
        btn.textContent = 'üîç Run Analysis Now';
    }
}

// ‚îÄ‚îÄ‚îÄ Embedding Status ‚îÄ‚îÄ‚îÄ
async function loadEmbeddingStatus() {
    const container = document.getElementById('embedding-status-container');
    if (!container) return;
    try {
        const data = await api('/api/embeddings/status');
        if (!data) {
            container.innerHTML = '<div class="empty-state">Failed to load embedding status</div>';
            return;
        }
        const enabled = data.enabled;
        const total = data.totalEmbeddings || 0;
        const incidents = data.incidentEmbeddings || 0;
        const resolutions = data.resolutionEmbeddings || 0;
        const rcas = data.rcaEmbeddings || 0;
        const inMemory = data.inMemoryCount || 0;
        const model = data.model || 'unknown';
        const dims = data.dimensions || 0;
        const running = data.migrationRunning;
        const lastAt = data.lastMigrationAt !== 'never' ? new Date(data.lastMigrationAt).toLocaleString() : 'Never';

        container.innerHTML = `
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:12px;">
                <div style="text-align:center;padding:8px;background:var(--bg-input);border-radius:var(--radius-sm);">
                    <div style="font-size:20px;font-weight:700;color:var(--accent);">${total}</div>
                    <div style="font-size:11px;color:var(--text-dim);">Total Embeddings</div>
                </div>
                <div style="text-align:center;padding:8px;background:var(--bg-input);border-radius:var(--radius-sm);">
                    <div style="font-size:20px;font-weight:700;color:var(--yellow);">${incidents}</div>
                    <div style="font-size:11px;color:var(--text-dim);">Incidents</div>
                </div>
                <div style="text-align:center;padding:8px;background:var(--bg-input);border-radius:var(--radius-sm);">
                    <div style="font-size:20px;font-weight:700;color:var(--green);">${resolutions}</div>
                    <div style="font-size:11px;color:var(--text-dim);">Resolutions</div>
                </div>
                <div style="text-align:center;padding:8px;background:var(--bg-input);border-radius:var(--radius-sm);">
                    <div style="font-size:20px;font-weight:700;color:var(--blue);">${rcas}</div>
                    <div style="font-size:11px;color:var(--text-dim);">RCA Reports</div>
                </div>
            </div>
            <div style="display:flex;gap:16px;font-size:12px;color:var(--text-dim);">
                <span>Status: ${enabled ? '<span style="color:var(--green);">Enabled</span>' : '<span style="color:var(--red);">Disabled</span>'}</span>
                <span>Model: <span style="color:var(--text);">${model}</span></span>
                <span>Dimensions: <span style="color:var(--text);">${dims}</span></span>
                <span>In Memory: <span style="color:var(--text);">${inMemory}</span></span>
                ${running ? '<span style="color:var(--yellow);">Migration running...</span>' : ''}
                <span>Last migration: ${lastAt}</span>
            </div>
        `;
    } catch (e) {
        container.innerHTML = '<div class="empty-state">Failed to load embedding status</div>';
    }
}

async function migrateEmbeddings() {
    if (!confirm('Embed all records that are currently missing embeddings?')) return;
    try {
        const result = await fetch('/api/embeddings/migrate', { method: 'POST' }).then(r => r.json());
        alert('Migration complete: ' + (result.newEmbeddings || 0) + ' new embeddings generated.');
        loadEmbeddingStatus();
    } catch (e) {
        alert('Migration failed: ' + e.message);
    }
}

async function reindexEmbeddings() {
    if (!confirm('Re-embed ALL records? This may take a while and will make API calls for every record.')) return;
    try {
        const result = await fetch('/api/embeddings/reindex', { method: 'POST' }).then(r => r.json());
        alert('Re-index complete: ' + (result.embeddingsGenerated || 0) + ' embeddings generated.');
        loadEmbeddingStatus();
    } catch (e) {
        alert('Re-index failed: ' + e.message);
    }
}

async function loadDashboardRisks() {
    const container = document.getElementById('dashboard-risks-container');
    if (!container) return;
    try {
        const risks = await api('/api/risks/latest');
        if (!risks || !risks.length) {
            container.innerHTML = '<div class="empty-state">No risks identified ‚Äî system looks healthy!</div>';
            return;
        }
        const openRisks = risks.filter(r => r.status === 'OPEN');
        if (openRisks.length === 0) {
            container.innerHTML = '<div style="color:var(--green);">All risks have been addressed. ‚úÖ</div>';
            return;
        }
        container.innerHTML = openRisks.slice(0, 5).map(r => {
            const sevColor = r.severity === 'CRITICAL' ? 'var(--red)' : r.severity === 'HIGH' ? 'var(--orange)' : r.severity === 'MEDIUM' ? 'var(--yellow)' : 'var(--blue)';
            return `<div style="padding:6px 0;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;">
                <span style="color:${sevColor};font-weight:600;font-size:11px;min-width:55px;">${r.severity}</span>
                <span style="flex:1;">${r.riskTitle}</span>
                <span style="color:var(--text-dim);font-size:11px;">${r.service || 'system'}</span>
            </div>`;
        }).join('');
    } catch (e) {
        container.innerHTML = '<div class="empty-state">Failed to load risks</div>';
    }
}

// ‚îÄ‚îÄ‚îÄ Executive Summaries ‚îÄ‚îÄ‚îÄ

async function loadLearningExecSummary() {
    const contentEl = document.getElementById('learning-exec-summary-content');
    const timeEl = document.getElementById('learning-exec-summary-time');
    try {
        const data = await api('/api/learning/executive-summary');
        if (data && data.summary) {
            contentEl.textContent = data.summary;
            timeEl.textContent = data.generatedAt ? 'Generated: ' + new Date(data.generatedAt).toLocaleString() : '';
        }
    } catch (e) {
        contentEl.textContent = 'Failed to load executive summary.';
        timeEl.textContent = '';
    }
}

async function refreshLearningExecSummary() {
    const btn = document.getElementById('learning-exec-refresh-btn');
    const contentEl = document.getElementById('learning-exec-summary-content');
    const timeEl = document.getElementById('learning-exec-summary-time');
    btn.disabled = true;
    btn.textContent = 'Generating...';
    contentEl.textContent = 'Generating summary with AI...';
    timeEl.textContent = '';
    try {
        const data = await api('/api/learning/executive-summary/refresh', { method: 'POST' });
        if (data && data.summary) {
            contentEl.textContent = data.summary;
            timeEl.textContent = data.generatedAt ? 'Generated: ' + new Date(data.generatedAt).toLocaleString() : '';
        } else {
            contentEl.textContent = 'Summary generation returned empty content.';
        }
    } catch (e) {
        contentEl.textContent = 'Failed to generate executive summary.';
    } finally {
        btn.disabled = false;
        btn.textContent = 'Refresh';
    }
}

async function loadRcaExecSummary() {
    const contentEl = document.getElementById('rca-exec-summary-content');
    const timeEl = document.getElementById('rca-exec-summary-time');
    try {
        const data = await api('/api/rca/executive-summary');
        if (data && data.summary) {
            contentEl.textContent = data.summary;
            timeEl.textContent = data.generatedAt ? 'Generated: ' + new Date(data.generatedAt).toLocaleString() : '';
        }
    } catch (e) {
        contentEl.textContent = 'Failed to load executive summary.';
        timeEl.textContent = '';
    }
}

async function refreshRcaExecSummary() {
    const btn = document.getElementById('rca-exec-refresh-btn');
    const contentEl = document.getElementById('rca-exec-summary-content');
    const timeEl = document.getElementById('rca-exec-summary-time');
    btn.disabled = true;
    btn.textContent = 'Generating...';
    contentEl.textContent = 'Generating summary with AI...';
    timeEl.textContent = '';
    try {
        const data = await api('/api/rca/executive-summary/refresh', { method: 'POST' });
        if (data && data.summary) {
            contentEl.textContent = data.summary;
            timeEl.textContent = data.generatedAt ? 'Generated: ' + new Date(data.generatedAt).toLocaleString() : '';
        } else {
            contentEl.textContent = 'Summary generation returned empty content.';
        }
    } catch (e) {
        contentEl.textContent = 'Failed to generate executive summary.';
    } finally {
        btn.disabled = false;
        btn.textContent = 'Refresh';
    }
}

// ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ
connectWs();
refreshDashboard();
setTimeout(() => {
    loadTools(); refreshServices(); refreshIncidents(); refreshAlerts();
    loadPlaybooks(); refreshApprovals(); refreshAuditLog(); refreshInsights(); loadLearnings();
    loadRcaReports(); refreshRcaBadge();
    loadRisks(); refreshRiskBadge(); loadDashboardRisks();
    loadEmbeddingStatus();
    loadLearningExecSummary(); loadRcaExecSummary();
}, 500);
setInterval(refreshDashboard, 15000);
setInterval(refreshApprovals, 30000);
setInterval(refreshInsights, 60000);
setInterval(loadSuggestions, 120000);
setInterval(refreshRcaBadge, 30000);
setInterval(() => { refreshRiskBadge(); loadDashboardRisks(); }, 60000);
setInterval(loadEmbeddingStatus, 60000);
</script>
</body>
</html>
